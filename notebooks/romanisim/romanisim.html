
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Simulating WFI Imaging Data with Roman I-Sim &#8212; STScI Roman Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/romanisim/romanisim';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Calibrating WFI Exposures with RomanCal" href="../exposure_pipeline/exposure_pipeline.html" />
    <link rel="prev" title="How to Open Roman Data Files (ASDF)" href="../working_with_asdf/working_with_asdf.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI Roman Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI Roman Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Nancy Grace Roman Space Telescope Notebooks
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data_discovery_and_access/data_discovery_and_access.html">Roman Research Nexus Data Discovery and Access in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_asdf/working_with_asdf.html">How to Open Roman Data Files (ASDF)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Simulating WFI Imaging Data with Roman I-Sim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exposure_pipeline/exposure_pipeline.html">Calibrating WFI Exposures with RomanCal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ground_test_analysis/wfi_tvac_brightstar.html">Diving Into WFI TVAC Bright Star Test Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/aperture_photometry.html">Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../measuring_galaxy_shapes/measuring_galaxy_shapes.html">Measuring Galaxy Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grism_spectral_extraction/grism_spectral_extraction.html">Roman Spectroscopy: Grism Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rist/rist.html">The Roman Interactive Sensitivity Tool (RIST)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stips/stips.html">STIPS Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stpsf/stpsf.html">STPSF Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../synphot/synphot.html">Roman WFI Synthetic Photometry with synphot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pandeia/pandeia.html">Pandeia Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../footprint_visualization/footprint_visualization.html">Visualization of Roman APT products</a></li>

<li class="toctree-l1"><a class="reference internal" href="../background_visualization_tool/RBVT.html">The Roman Background Visualization Tool (RBVT)</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/roman_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/roman_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/romanisim/romanisim.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/romanisim/romanisim.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Simulating WFI Imaging Data with Roman I-Sim</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nexus-server-information">Nexus Server Information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-information-and-read-only-status">Kernel Information and Read-Only Status</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-data">Reference Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#local-run-settings">Local Run Settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-the-roman-research-nexus">On the Roman Research Nexus</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-data">Tutorial Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#source-catalog-generation">Source Catalog Generation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-simulation">Image Simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-use-cases">Advanced Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dithered-observations">Dithered Observations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallelized-simulations">Parallelized Simulations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulating-dithered-observations-in-parallel">Simulating Dithered Observations in Parallel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#injecting-sources-into-l2-images">Injecting Sources into L2 Images</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="simulating-wfi-imaging-data-with-roman-i-sim">
<h1>Simulating WFI Imaging Data with Roman I-Sim<a class="headerlink" href="#simulating-wfi-imaging-data-with-roman-i-sim" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<section id="nexus-server-information">
<h2>Nexus Server Information<a class="headerlink" href="#nexus-server-information" title="Link to this heading">#</a></h2>
<p><strong>IMPORTANT: Running the parallelized examples in the advanced use cases section will require a “Medium” or larger server.</strong></p>
</section>
<section id="kernel-information-and-read-only-status">
<h2>Kernel Information and Read-Only Status<a class="headerlink" href="#kernel-information-and-read-only-status" title="Link to this heading">#</a></h2>
<p>To run this notebook, please select the “Roman Calibration” kernel at the top right of your window.</p>
<p>This notebook is read-only. You can run cells and make edits, but you must save changes to a different location. We recommend saving the notebook within your home directory, or to a new folder within your home (e.g. <span style="font-variant:small-caps;">file &gt; save notebook as &gt; my-nbs/nb.ipynb</span>). Note that a directory must exist before you attempt to add a notebook to it.</p>
</section>
<section id="reference-data">
<h2>Reference Data<a class="headerlink" href="#reference-data" title="Link to this heading">#</a></h2>
<p>The cell below will check to ensure ancillary reference files for the <code class="docutils literal notranslate"><span class="pre">stpsf</span></code> package are installed. If not, it will download the ancillary reference files and install them under your home directory (i.e., <code class="docutils literal notranslate"><span class="pre">${HOME}/refdata/</span></code>).</p>
<section id="local-run-settings">
<h3>Local Run Settings<a class="headerlink" href="#local-run-settings" title="Link to this heading">#</a></h3>
<p>If you want to run the notebook in your local machine, refer to the information in the <a class="reference internal" href="#../../../markdown/local-run.md"><span class="xref myst">local installation</span></a> instructions before proceeding with the notebook. The instructions provide inportant information about setting up your environment, installing dependnecies, and adding to your working directory scripts to help with the reference data installation.</p>
<p>Depending on which (if any) reference data are missing, this cell may take several minutes to execute.</p>
</section>
<section id="on-the-roman-research-nexus">
<h3>On the Roman Research Nexus<a class="headerlink" href="#on-the-roman-research-nexus" title="Link to this heading">#</a></h3>
<p>If you are working on the Nexus, then the ancillary reference data are pre-installed and this cell will execute instantly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">notebook_data_dependencies</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ndd</span>

<span class="c1"># Download reference data (if necessary)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ndd</span><span class="o">.</span><span class="n">install_files</span><span class="p">(</span><span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;stpsf&#39;</span><span class="p">])</span>
<span class="n">ndd</span><span class="o">.</span><span class="n">setup_env</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found stpsf path /home/runner/refdata/stpsf-data
Reference data paths set to:
	STPSF_PATH = /home/runner/refdata/stpsf-data
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<p>Libraries used</p>
<ul class="simple">
<li><p><em>argparse</em> for formatting input options in romanisim</p></li>
<li><p><em>asdf</em> for opening Roman WFI ASDF files</p></li>
<li><p><em>astroquery.gaia</em> for querying the Gaia catalog</p></li>
<li><p><em>astropy.coordinates</em> for storing celestial coordinates as Python objects</p></li>
<li><p><em>astropy.time</em> for storing time information as Python objects</p></li>
<li><p><em>astropy.table</em> for working with Astropy Table objects</p></li>
<li><p><em>astropy.units</em> for handling and combining units</p></li>
<li><p><em>astropy.visualization</em> for image normalization</p></li>
<li><p><em>copy</em> for making copies of Python objects</p></li>
<li><p><em>galsim</em> for image simulations</p></li>
<li><p><em>importlib</em> for reloading Python modules</p></li>
<li><p><em>matplotlib</em> for displaying images</p></li>
<li><p><em>numpy</em> for array operations</p></li>
<li><p><em>os</em> for file operations</p></li>
<li><p><em>romanisim</em> for image simulations</p></li>
<li><p><em>roman_datamodels</em> for opening Roman WFI ASDF files</p></li>
<li><p><em>s3fs</em> for accessing files in an S3 bucket</p></li>
</ul>
<p>In the <a class="reference internal" href="#Advanced-Use-Cases"><span class="xref myst">Advanced Use Cases</span></a> section further below, we include some additional imports:</p>
<ul class="simple">
<li><p><em>pysiaf</em> for determining dither positions</p></li>
<li><p><em>dataclasses</em> for creating a class</p></li>
<li><p><em>typing</em> for doing type checking on inputs</p></li>
<li><p><em>dask</em> for parallelization</p></li>
</ul>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">dask</span></code> is not installed in the Roman Calibration kernel by default. In the <a class="reference internal" href="#Parallelized-Simulations"><span class="xref myst">Advanced Use Cases - Parallelized Simulations</span></a> section, the code cells have been commented out and there is a cell at the beginning of the section that will use <code class="docutils literal notranslate"><span class="pre">pip</span></code> to install the required packages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asdf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.gaia</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaia</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">galsim</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">roman_datamodels</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">romanisim</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaia</span><span class="p">,</span> <span class="n">bandpass</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">persistence</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">ris_make_utils</span> <span class="k">as</span> <span class="n">ris</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">romanisim.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">inject_sources_into_l2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">s3fs</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>The purpose of this notebook is to show how to generate simulated Level 1 (L1; uncalibrated ramp cubes) and Level 2 (L2; calibrated rate images) Roman Wide Field Instrument (WFI) Advanced Scientific Data Format (ASDF) files with <a class="reference external" href="https://romanisim.readthedocs.io/en/latest/">Roman I-Sim</a> (package name <code class="docutils literal notranslate"><span class="pre">romanisim</span></code>). Details about the Roman data levels can be found in the <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/wfi-data-format/data-levels-and-products">Data Levels and Products</a> article in the Roman Documentation System (RDox). Briefly, a L1 file contains a single uncalibrated ramp exposure in units of Data Numbers (DN).  L1 files are three-dimensional data cubes, one dimension for time and two dimensions for image coordinates, that are shaped as  arrays with (N resultants, 4096 image rows, 4096 image columns). A resultant is a sample up-the-ramp, and represents either a single read of the WFI detectors or multiple reads that have been combined. The L2 WFI data are calibrated images in instrumental units of DN / second.  They are two-dimensional arrays shaped as (4088 image rows, 4088 image columns).</p>
</section>
<hr class="docutils" />
<section id="tutorial-data">
<h2>Tutorial Data<a class="headerlink" href="#tutorial-data" title="Link to this heading">#</a></h2>
<p>In this tutorial, we will create necessary data in memory or retrieve it from a catalog service. A catalog file is also available in the RRN S3 bucket, and can be streamed into memory using <code class="docutils literal notranslate"><span class="pre">astropy.table.Table</span></code> and the <code class="docutils literal notranslate"><span class="pre">s3fs</span></code> package instructions in the <a class="reference internal" href="../data_discovery_and_access/data_discovery_and_access.html"><span class="std std-doc">Data Discovery and Access</span></a> tutorial. Also see the <a class="reference internal" href="#../../../markdown/simulated-data.md"><span class="xref myst">RRN documentation</span></a> for more information on the catalog available in the S3 bucket.</p>
</section>
<section id="source-catalog-generation">
<h2>Source Catalog Generation<a class="headerlink" href="#source-catalog-generation" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">romanisim</span></code> package offers two options for generating source catalogs:</p>
<ol class="arabic simple">
<li><p>Retrieve the source catalog from Gaia; or</p></li>
<li><p>Parametrically generate a catalog of stars and/or galaxies.</p></li>
</ol>
<p>First, let’s explore how to create a <code class="docutils literal notranslate"><span class="pre">romanisim</span></code>-compatible source catalog using Gaia. We will use a combination of <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> and <code class="docutils literal notranslate"><span class="pre">romanisim</span></code> to query the Gaia catalog and then write the file in a format compatible with <code class="docutils literal notranslate"><span class="pre">romanisim</span></code>.</p>
<p>In the example below, we query the Gaia DR3 catalog for sources centered at (RA, Dec) = (270.94, -0.2) degrees within a radius of 1 degree.</p>
<p><strong>Note:</strong> The Gaia query may take several minutes to complete.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ra</span> <span class="o">=</span> <span class="mf">270.94</span>  <span class="c1"># Right ascension in degrees</span>
<span class="n">dec</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span>  <span class="c1"># Declination in degrees</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Search radius in degrees</span>

<span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM gaiadr3.gaia_source WHERE distance(</span><span class="si">{</span><span class="n">ra</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">, ra, dec) &lt; </span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">Gaia</span><span class="o">.</span><span class="n">launch_job_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:39 INFO     Query finished.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: Query finished. [astroquery.utils.tap.core]
&lt;Table length=389468&gt;
              name               dtype       unit                                                                  description                                                              n_bad 
------------------------------- ------- ------------- ------------------------------------------------------------------------------------------------------------------------------------- ------
                    solution_id   int64                                                                                                                                 Solution Identifier      0
                    designation  object                                                                                         Unique source designation (unique across all Data Releases)      0
                      source_id   int64                                                                                  Unique source identifier (unique within a particular Data Release)      0
                   random_index   int64                                                                                                         Random index for use when selecting subsets      0
                      ref_epoch float64            yr                                                                                                                       Reference epoch      0
                             ra float64           deg                                                                                                                       Right ascension      0
                       ra_error float32           mas                                                                                                     Standard error of right ascension      0
                            dec float64           deg                                                                                                                           Declination      0
                      dec_error float32           mas                                                                                                         Standard error of declination      0
                       parallax float64           mas                                                                                                                              Parallax  53139
                 parallax_error float32           mas                                                                                                            Standard error of parallax  53139
            parallax_over_error float32                                                                                                              Parallax divided by its standard error  53139
                             pm float32      mas / yr                                                                                                                   Total proper motion  53139
                           pmra float64      mas / yr                                                                                            Proper motion in right ascension direction  53139
                     pmra_error float32      mas / yr                                                                          Standard error of proper motion in right ascension direction  53139
                          pmdec float64      mas / yr                                                                                                Proper motion in declination direction  53139
                    pmdec_error float32      mas / yr                                                                              Standard error of proper motion in declination direction  53139
                    ra_dec_corr float32                                                                                                 Correlation between right ascension and declination      0
               ra_parallax_corr float32                                                                                                    Correlation between right ascension and parallax  53139
                   ra_pmra_corr float32                                                                            Correlation between right ascension and proper motion in right ascension  53139
                  ra_pmdec_corr float32                                                                                Correlation between right ascension and proper motion in declination  53139
              dec_parallax_corr float32                                                                                                        Correlation between declination and parallax  53139
                  dec_pmra_corr float32                                                                                Correlation between declination and proper motion in right ascension  53139
                 dec_pmdec_corr float32                                                                                    Correlation between declination and proper motion in declination  53139
             parallax_pmra_corr float32                                                                                   Correlation between parallax and proper motion in right ascension  53139
            parallax_pmdec_corr float32                                                                                       Correlation between parallax and proper motion in declination  53139
                pmra_pmdec_corr float32                                                               Correlation between proper motion in right ascension and proper motion in declination  53139
           astrometric_n_obs_al   int16                                                                                       Total number of observations in the along-scan (AL) direction      0
           astrometric_n_obs_ac   int16                                                                                      Total number of observations in the across-scan (AC) direction      0
      astrometric_n_good_obs_al   int16                                                                                        Number of good observations in the along-scan (AL) direction      0
       astrometric_n_bad_obs_al   int16                                                                                         Number of bad observations in the along-scan (AL) direction      0
             astrometric_gof_al float32                                                                                      Goodness of fit statistic of model wrt along-scan observations      0
            astrometric_chi2_al float32                                                                                                                                 AL chi-square value      0
       astrometric_excess_noise float32           mas                                                                                                            Excess noise of the source      0
   astrometric_excess_noise_sig float32                                                                                                                        Significance of excess noise      0
      astrometric_params_solved   int16                                                                                                              Which parameters have been solved for?      0
       astrometric_primary_flag    bool                                                                                                                                 Primary or seconday      0
      nu_eff_used_in_astrometry float32        1 / um                                                                   Effective wavenumber of the source used in the astrometric solution 237998
                   pseudocolour float32        1 / um                                                                                  Astrometrically estimated pseudocolour of the source 204609
             pseudocolour_error float32        1 / um                                                                                      Standard error of the pseudocolour of the source 204609
           ra_pseudocolour_corr float32                                                                                                Correlation between right ascension and pseudocolour 204609
          dec_pseudocolour_corr float32                                                                                                    Correlation between declination and pseudocolour 204609
     parallax_pseudocolour_corr float32                                                                                                       Correlation between parallax and pseudocolour 204609
         pmra_pseudocolour_corr float32                                                                                Correlation between proper motion in right asension and pseudocolour 204609
        pmdec_pseudocolour_corr float32                                                                                   Correlation between proper motion in declination and pseudocolour 204609
   astrometric_matched_transits   int16                                                                                                      Matched FOV transits used in the AGIS solution      0
        visibility_periods_used   int16                                                                                           Number of visibility periods used in Astrometric solution      0
        astrometric_sigma5d_max float32           mas                                                                                The longest semi-major axis of the 5-d error ellipsoid      0
               matched_transits   int16                                                                                                       The number of transits matched to this source      0
           new_matched_transits   int16                                                              The number of transits newly incorporated into an existing source in the current cycle      0
       matched_transits_removed   int16                                                                         The number of transits removed from an existing source in the current cycle      0
     ipd_gof_harmonic_amplitude float32                                                                                              Amplitude of the IPD GoF versus position angle of scan      0
         ipd_gof_harmonic_phase float32           deg                                                                                    Phase of the IPD GoF versus position angle of scan      0
            ipd_frac_multi_peak   int16                                                                                           Percent of successful-IPD windows with more than one peak      0
               ipd_frac_odd_win   int16                                                                                         Percent of transits with truncated windows or multiple gate      0
                           ruwe float32                                                                                                                      Renormalised unit weight error  53139
     scan_direction_strength_k1 float32                                                                                        Degree of concentration of scan directions across the source   5602
     scan_direction_strength_k2 float32                                                                                        Degree of concentration of scan directions across the source   5602
     scan_direction_strength_k3 float32                                                                                        Degree of concentration of scan directions across the source   5602
     scan_direction_strength_k4 float32                                                                                        Degree of concentration of scan directions across the source   5602
         scan_direction_mean_k1 float32           deg                                                                              Mean position angle of scan directions across the source   5602
         scan_direction_mean_k2 float32           deg                                                                              Mean position angle of scan directions across the source   5602
         scan_direction_mean_k3 float32           deg                                                                              Mean position angle of scan directions across the source   5602
         scan_direction_mean_k4 float32           deg                                                                              Mean position angle of scan directions across the source   5602
              duplicated_source    bool                                                                                                             Source with multiple source identifiers      0
                   phot_g_n_obs   int16                                                                                                 Number of observations contributing to G photometry      0
               phot_g_mean_flux float64  electron / s                                                                                                                      G-band mean flux    630
         phot_g_mean_flux_error float32  electron / s                                                                                                             Error on G-band mean flux    630
    phot_g_mean_flux_over_error float32                                                                                                               G-band mean flux divided by its error    630
                phot_g_mean_mag float32           mag                                                                                                                 G-band mean magnitude    630
                  phot_bp_n_obs   int16                                                                                                Number of observations contributing to BP photometry      0
              phot_bp_mean_flux float64  electron / s                                                                                                               Integrated BP mean flux  24166
        phot_bp_mean_flux_error float32  electron / s                                                                                                  Error on the integrated BP mean flux  24166
   phot_bp_mean_flux_over_error float32                                                                                                        Integrated BP mean flux divided by its error  24166
               phot_bp_mean_mag float32           mag                                                                                                          Integrated BP mean magnitude  24166
                  phot_rp_n_obs   int16                                                                                                Number of observations contributing to RP photometry      0
              phot_rp_mean_flux float64  electron / s                                                                                                               Integrated RP mean flux  22318
        phot_rp_mean_flux_error float32  electron / s                                                                                                  Error on the integrated RP mean flux  22318
   phot_rp_mean_flux_over_error float32                                                                                                        Integrated RP mean flux divided by its error  22318
               phot_rp_mean_mag float32           mag                                                                                                          Integrated RP mean magnitude  22318
       phot_bp_rp_excess_factor float32                                                                                                                                 BP/RP excess factor  24285
phot_bp_n_contaminated_transits   int16                                                                                                                  Number of BP contaminated transits  24166
     phot_bp_n_blended_transits   int16                                                                                                                       Number of BP blended transits  24166
phot_rp_n_contaminated_transits   int16                                                                                                                  Number of RP contaminated transits  22318
     phot_rp_n_blended_transits   int16                                                                                                                       Number of RP blended transits  22318
                 phot_proc_mode   int16                                                                                                                          Photometry processing mode    153
                          bp_rp float32           mag                                                                                                                        BP - RP colour  24285
                           bp_g float32           mag                                                                                                                         BP - G colour  24167
                           g_rp float32           mag                                                                                                                         G - RP colour  22794
                radial_velocity float32        km / s                                                                                                                       Radial velocity 383852
          radial_velocity_error float32        km / s                                                                                                                 Radial velocity error 383852
                 rv_method_used   int16                                                                                                           Method used to obtain the radial velocity 383852
                 rv_nb_transits   int16                                                                                              Number of transits used to compute the radial velocity 383852
       rv_nb_deblended_transits   int16                                                                                             Number of valid transits that have undergone deblending 383852
     rv_visibility_periods_used   int16                                                                                   Number of visibility periods used to estimate the radial velocity 383852
       rv_expected_sig_to_noise float32                                                 Expected signal to noise ratio in the combination of the spectra used to obtain the radial velocity 383852
            rv_renormalised_gof float32                                                                                                        Radial velocity renormalised goodness of fit 388325
                rv_chisq_pvalue float32                                                                                              P-value for constancy based on a chi-squared criterion 388324
               rv_time_duration float32             d                                                                                      Time coverage of the radial velocity time series 383852
            rv_amplitude_robust float32        km / s                                                              Total amplitude in the radial velocity time series after outlier removal 388324
               rv_template_teff float32             K                                                                              Teff of the template used to compute the radial velocity 383852
               rv_template_logg float32 log(cm.s**-2)                                                                              Logg of the template used to compute the radial velocity 383852
               rv_template_fe_h float32           dex                                                                           [Fe/H] of the template used to compute the radial velocityy 383852
            rv_atm_param_origin   int16                                                                                     Origin of the atmospheric parameters associated to the template 383852
                         vbroad float32        km / s                                                                                                    Spectral line broadening parameter 388785
                   vbroad_error float32        km / s                                                                                           Uncertainty on the spectral line broadening 388785
             vbroad_nb_transits   int16                                                                                                           Number of transits used to compute vbroad 388785
                       grvs_mag float32           mag                                                                                                             Integrated Grvs magnitude 383964
                 grvs_mag_error float32           mag                                                                                                            Grvs magnitude uncertainty 383964
           grvs_mag_nb_transits   int16                                                                                                             Number of transits used to compute Grvs 383964
          rvs_spec_sig_to_noise float32                                                                                                      Signal to noise ratio in the mean RVS spectrum 389417
             phot_variable_flag  object                                                                                                                        Photometric variability flag      0
                              l float64           deg                                                                                                                    Galactic longitude      0
                              b float64           deg                                                                                                                     Galactic latitude      0
                        ecl_lon float64           deg                                                                                                                    Ecliptic longitude      0
                        ecl_lat float64           deg                                                                                                                     Ecliptic latitude      0
              in_qso_candidates    bool                                                              Flag indicating the availability of additional information in the QSO candidates table      0
           in_galaxy_candidates    bool                                                           Flag indicating the availability of additional information in the galaxy candidates table      0
                non_single_star   int16                                                    Flag indicating the availability of additional information in the various Non-Single Star tables      0
              has_xp_continuous    bool                                                Flag indicating the availability of mean BP/RP spectrum in continuous representation for this source      0
                 has_xp_sampled    bool                                                             Flag indicating the availability of mean BP/RP spectrum in sampled form for this source      0
                        has_rvs    bool                                                                               Flag indicating the availability of mean RVS spectrum for this source      0
           has_epoch_photometry    bool                                                                                Flag indicating the availability of epoch photometry for this source      0
                   has_epoch_rv    bool                                                                           Flag indicating the availability of epoch radial velocity for this source      0
               has_mcmc_gspphot    bool                                                                           Flag indicating the availability of GSP-Phot MCMC samples for this source      0
                   has_mcmc_msc    bool                                                                                Flag indicating the availability of MSC MCMC samples for this source      0
            in_andromeda_survey    bool                                                          Flag indicating that the source is present in the Gaia Andromeda Photometric Survey (GAPS)      0
   classprob_dsc_combmod_quasar float32                                                  Probability from DSC-Combmod of being a quasar (data used: BP/RP spectrum, photometry, astrometry)  18878
   classprob_dsc_combmod_galaxy float32                                                  Probability from DSC-Combmod of being a galaxy (data used: BP/RP spectrum, photometry, astrometry)  18878
     classprob_dsc_combmod_star float32                     Probability from DSC-Combmod of being a single star (but not a white dwarf) (data used: BP/RP spectrum, photometry, astrometry)  18878
                   teff_gspphot float32             K                                                           Effective temperature from GSP-Phot Aeneas best library using BP/RP spectra 288418
             teff_gspphot_lower float32             K                           Lower confidence level (16%) of effective temperature from GSP-Phot Aeneas best library using BP/RP spectra 288418
             teff_gspphot_upper float32             K                           Upper confidence level (84%) of effective temperature from GSP-Phot Aeneas best library using BP/RP spectra 288418
                   logg_gspphot float32 log(cm.s**-2)                                                                 Surface gravity from GSP-Phot Aeneas best library using BP/RP spectra 288418
             logg_gspphot_lower float32 log(cm.s**-2)                                 Lower confidence level (16%) of surface gravity from GSP-Phot Aeneas best library using BP/RP spectra 288418
             logg_gspphot_upper float32 log(cm.s**-2)                                 Upper confidence level (84%) of surface gravity from GSP-Phot Aeneas best library using BP/RP spectra 288418
                     mh_gspphot float32           dex                                                                  Iron abundance from GSP-Phot Aeneas best library using BP/RP spectra 288418
               mh_gspphot_lower float32           dex                                  Lower confidence level (16%) of iron abundance from GSP-Phot Aeneas best library using BP/RP spectra 288418
               mh_gspphot_upper float32           dex                                  Upper confidence level (84%) of iron abundance from GSP-Phot Aeneas best library using BP/RP spectra 288418
               distance_gspphot float32            pc                                                                        Distance from GSP-Phot Aeneas best library using BP/RP spectra 288418
         distance_gspphot_lower float32            pc                                        Lower confidence level (16%) of distance from GSP-Phot Aeneas best library using BP/RP spectra 288418
         distance_gspphot_upper float32            pc                                        Upper confidence level (84%) of distance from GSP-Phot Aeneas best library using BP/RP spectra 288418
                  azero_gspphot float32           mag                                       Monochromatic extinction $A_0$ at 547.7nm from GSP-Phot Aeneas best library using BP/RP spectra 288418
            azero_gspphot_lower float32           mag       Lower confidence level (16%) of monochromatic extinction $A_0$ at 547.7nm from GSP-Phot Aeneas best library using BP/RP spectra 288418
            azero_gspphot_upper float32           mag       Upper confidence level (84%) of monochromatic extinction $A_0$ at 547.7nm from GSP-Phot Aeneas best library using BP/RP spectra 288418
                     ag_gspphot float32           mag                                                            Extinction in G band from GSP-Phot Aeneas best library using BP/RP spectra 288418
               ag_gspphot_lower float32           mag                            Lower confidence level (16%) of extinction in G band from GSP-Phot Aeneas best library using BP/RP spectra 288418
               ag_gspphot_upper float32           mag                            Upper confidence level (84%) of extinction in G band from GSP-Phot Aeneas best library using BP/RP spectra 288418
               ebpminrp_gspphot float32           mag                                          Reddening $E(G_{\rm BP} - G_{\rm RP})$ from GSP-Phot Aeneas best library using BP/RP spectra 288418
         ebpminrp_gspphot_lower float32           mag         Lower confidence level (16%) of reddening  $E(G_{\rm BP} - G_{\rm RP})$ from GSP-Phot Aeneas best library using BP/RP spectra 288418
         ebpminrp_gspphot_upper float32           mag         Upper confidence level (84%) of reddening  $E(G_{\rm BP} - G_{\rm RP})$ from GSP-Phot Aeneas best library using BP/RP spectra 288418
                libname_gspphot  object               Name of library that achieves the highest mean log-posterior in MCMC samples and was used to derive GSP-Phot parameters in this table      0
Jobid: 82c0ac99-d6c9-11f0-9f4e-bc97e148b76b-O
Phase: COMPLETED
Owner: None
Output file: async_20251211194222.vot
Results: None
</pre></div>
</div>
</div>
</div>
<p>Once we have the result from the Gaia query, we can transform it into a format compatible with Roman I-Sim:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter the Gaia results for stars and exclude bright stars</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;classprob_dsc_combmod_star&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.7</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;phot_g_mean_mag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">16.5</span><span class="p">]</span>

<span class="c1"># Set the observation time</span>
<span class="n">obs_time</span> <span class="o">=</span> <span class="s1">&#39;2026-10-31T00:00:00&#39;</span>

<span class="c1"># Make the Roman I-Sim formatted catalog</span>
<span class="n">gaia_catalog</span> <span class="o">=</span> <span class="n">gaia</span><span class="o">.</span><span class="n">gaia2romanisimcat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Time</span><span class="p">(</span><span class="n">obs_time</span><span class="p">),</span> <span class="n">fluxfields</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">bandpass</span><span class="o">.</span><span class="n">galsim2roman_bandpass</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>We have excluded very bright stars (Gaia g-band &gt; 16.5 mag in this example) because Roman I-Sim uses a maximum size of the simulated point spread function (PSF) in pixels that can result in the appearance of box-shaped boundaries around bright sources. This will be fixed in a future update.</p>
<p>When using a real catalog like Gaia, it is essential to remove any entries with missing information. This can be achieved with the code in the cell below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reject anything with missing fluxes or positions</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">gaia_catalog</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">]</span>
<span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">]</span>

<span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaia_catalog</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
      <span class="n">bad</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">gaia_catalog</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gaia_catalog</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="s1">&#39;mask&#39;</span><span class="p">):</span>
           <span class="n">bad</span> <span class="o">|=</span> <span class="n">gaia_catalog</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>
      <span class="n">gaia_catalog</span> <span class="o">=</span> <span class="n">gaia_catalog</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have a catalog, let’s take a look at it. The catalog in memory is an <code class="docutils literal notranslate"><span class="pre">astropy.table.Table</span></code> object with over 1e5 rows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gaia_catalog</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=308578</i>
<table id="table139913687354896" class="table-striped table-bordered table-condensed">
<thead><tr><th>ra</th><th>dec</th><th>type</th><th>n</th><th>half_light_radius</th><th>pa</th><th>ba</th><th>F087</th><th>F158</th><th>F146</th><th>F129</th><th>F213</th><th>F184</th><th>F106</th><th>F062</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>str3</th><th>int64</th><th>int64</th><th>int64</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>271.19129613484586</td><td>-1.1677613835078477</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td><td>7.6987404386869e-09</td></tr>
<tr><td>271.09450738004523</td><td>-1.185891080497458</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td><td>8.720800176983999e-09</td></tr>
<tr><td>271.1067045607792</td><td>-1.1705607386426884</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td><td>3.9809668017158344e-08</td></tr>
<tr><td>271.0875037421011</td><td>-1.1810658578077189</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td><td>8.414217479850343e-09</td></tr>
<tr><td>271.0952940937574</td><td>-1.1764766665382813</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td><td>2.951290105766723e-08</td></tr>
<tr><td>271.0958091400958</td><td>-1.17217366554771</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td><td>3.644473751435503e-08</td></tr>
<tr><td>271.0929744751323</td><td>-1.1685017594340839</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td><td>5.529973924709251e-08</td></tr>
<tr><td>271.0983758256309</td><td>-1.161585594182199</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td><td>1.2025314283427287e-08</td></tr>
<tr><td>271.1471396728475</td><td>-1.1617762687469662</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td><td>8.546476629428577e-09</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>270.85769202755245</td><td>0.773636140913735</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td></tr>
<tr><td>270.8678714354956</td><td>0.7813771659605562</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td></tr>
<tr><td>270.8810884457293</td><td>0.7918143514923536</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td></tr>
<tr><td>270.92454702622655</td><td>0.7993537136787594</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td></tr>
<tr><td>270.83084247667165</td><td>0.788319808618689</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td></tr>
<tr><td>270.8567519994558</td><td>0.7790670197665834</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td></tr>
<tr><td>270.8586204015057</td><td>0.7708144043522202</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td></tr>
<tr><td>270.8727696686416</td><td>0.7881045599926982</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td></tr>
<tr><td>270.85350681512693</td><td>0.789461511245047</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td></tr>
<tr><td>270.9061584399961</td><td>0.7992513585093951</td><td>PSF</td><td>-1</td><td>-1</td><td>-1</td><td>-1</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td></tr>
</table></div></div></div>
</div>
<p>Alternatively, we can generate a completely synthetic catalog of stars and galaxies using tools in Roman I-Sim (see parameters in the cell below). In this tutorial, we will simulate a galaxy catalog and merge it with the Gaia star catalog. This approach addresses the limitation of Gaia’s catalog, which includes only relatively bright sources, by adding galaxies. At the same time, real Gaia point sources are necessary for the Roman calibration pipeline to match images to Gaia astrometry.</p>
<p>Note that we can additionally simulate a star catalog if desired. This may be useful for including stars fainter than the Gaia magnitude limit, or when the Gaia astrometric step in RomanCal is not required.</p>
<p>Note that in the cell below, we have commented out the last line, which would save the catalog to disk as an Enhanced Character-Separated Values (ECSV) file. We do not need the catalog to be saved on disk for this tutorial, but you may optionally uncomment the line to save the file if you wish. The same file is available in the S3 bucket for any other tutorials that may need it. Having a saved version of the catalog removes the need to re-run the Gaia query above if you need to start over, but you will need to add code to read the catalog file below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Galaxy catalog parameters</span>

<span class="n">ra</span> <span class="o">=</span> <span class="mf">270.94</span>  <span class="c1"># Right ascension of the catalog center in degrees</span>
<span class="n">dec</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span>  <span class="c1"># Declination of the catalog center in degrees</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Radius of the catalog in degrees</span>
<span class="n">n_gal</span> <span class="o">=</span> <span class="mi">30_000</span>  <span class="c1"># Number of galaxies</span>
<span class="n">faint_mag</span> <span class="o">=</span> <span class="mi">22</span>  <span class="c1"># Faint magnitude limit of simulated sources</span>
<span class="n">hlight_radius</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># Half-light radius at the faint magnitude limit in units of arcseconds</span>
<span class="n">optical_element</span> <span class="o">=</span> <span class="s1">&#39;F062 F087 F106 F129 F146 F158 F184 F213&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  <span class="c1"># List of optical elements to simulate</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">4642</span>  <span class="c1"># Random number seed for reproducibility</span>

<span class="c1"># Create galaxy catalog</span>
<span class="n">galaxy_cat</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">make_galaxies</span><span class="p">(</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">),</span> <span class="n">n_gal</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">faintmag</span><span class="o">=</span><span class="n">faint_mag</span><span class="p">,</span> 
                                   <span class="n">hlr_at_faintmag</span><span class="o">=</span><span class="n">hlight_radius</span><span class="p">,</span> <span class="n">bandpasses</span><span class="o">=</span><span class="n">optical_element</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># Merge the galaxy and Gaia catalogs</span>
<span class="n">full_catalog</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">galaxy_cat</span><span class="p">,</span> <span class="n">gaia_catalog</span><span class="p">])</span>

<span class="c1">#full_catalog.write(&#39;full_catalog.ecsv&#39;, format=&#39;ascii.ecsv&#39;, overwrite=True)</span>
</pre></div>
</div>
</div>
</div>
<p>The following cell is commented out, but if uncommented will create a simulated star catalog.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#n_star = 30_000  # Number of stars</span>

<span class="c1">#star_cat = catalog.make_stars(SkyCoord(ra, dec, unit=&#39;deg&#39;), n_star, radius=radius, index=5/3., faintmag=faint_mag, </span>
<span class="c1">#                              truncation_radius=None, bandpasses=optical_element, rng=None, seed=seed)</span>
</pre></div>
</div>
</div>
</div>
<p>As before, we have commented out the line that will write this to disk, and instead have kept it in memory. Below, let’s print out the catalog and take a look:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">full_catalog</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=338578</i>
<table id="table139913701826896" class="table-striped table-bordered table-condensed">
<thead><tr><th>ra</th><th>dec</th><th>type</th><th>n</th><th>half_light_radius</th><th>pa</th><th>ba</th><th>F062</th><th>F087</th><th>F106</th><th>F129</th><th>F146</th><th>F158</th><th>F184</th><th>F213</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>str3</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>271.6295510520961</td><td>-0.03965028067096237</td><td>SER</td><td>3.516215236599453</td><td>0.8056893348693848</td><td>252.7303924560547</td><td>0.7235707640647888</td><td>3.6905281053378758e-09</td><td>1.1479291295302119e-08</td><td>1.2472877841673835e-08</td><td>6.86679868522333e-09</td><td>1.4913801305027619e-09</td><td>1.0117606308313043e-08</td><td>4.943988773931096e-09</td><td>2.402744225804554e-09</td></tr>
<tr><td>270.7539155586658</td><td>-1.175434326974954</td><td>SER</td><td>1.0399398592419549</td><td>0.946480393409729</td><td>336.08306884765625</td><td>0.4800519347190857</td><td>3.1115434673267828e-09</td><td>5.331648900153141e-09</td><td>9.049362148516593e-09</td><td>6.6658691899590394e-09</td><td>2.0099595321454444e-09</td><td>1.5802696040623232e-08</td><td>1.0280717610555712e-08</td><td>1.096286439405958e-08</td></tr>
<tr><td>270.8648924331985</td><td>0.5861049874846664</td><td>SER</td><td>2.8206730415136585</td><td>1.3277175426483154</td><td>73.26484680175781</td><td>0.6938181519508362</td><td>1.3153379718744418e-08</td><td>6.075517422488019e-09</td><td>3.1850986292880634e-09</td><td>7.20732051817663e-09</td><td>6.512435035688213e-09</td><td>6.66888944067523e-09</td><td>4.776757656088648e-09</td><td>6.596417634341378e-09</td></tr>
<tr><td>270.70544440611565</td><td>-0.1905627389524337</td><td>SER</td><td>1.2080757918109357</td><td>0.573934018611908</td><td>273.72601318359375</td><td>0.5772462487220764</td><td>3.2391787030405794e-09</td><td>1.9316861443741118e-09</td><td>3.5669256437387276e-09</td><td>1.699146068290247e-08</td><td>9.461913919039944e-09</td><td>7.503919152718197e-10</td><td>4.7414845383286774e-09</td><td>5.4636619672976394e-09</td></tr>
<tr><td>271.0763272819082</td><td>0.28776831750222365</td><td>SER</td><td>2.7301807784747587</td><td>5.05323600769043</td><td>236.8221435546875</td><td>0.907397985458374</td><td>7.582467986821939e-08</td><td>7.082852704343168e-08</td><td>3.547680762494565e-07</td><td>2.0032227610045084e-07</td><td>2.793574651605013e-07</td><td>2.3345998556578706e-07</td><td>3.1447200399270514e-07</td><td>1.8613071972595208e-07</td></tr>
<tr><td>271.1748280956513</td><td>0.707003102302135</td><td>SER</td><td>3.1848109641065934</td><td>0.10060989856719971</td><td>126.41947937011719</td><td>0.7899426817893982</td><td>1.5315970713913885e-09</td><td>8.170578102983939e-10</td><td>1.1321914517026244e-09</td><td>5.698110872032203e-09</td><td>3.009007709664502e-09</td><td>2.8135679897012267e-10</td><td>2.320242442621634e-09</td><td>2.7085311771202214e-09</td></tr>
<tr><td>270.2732744737068</td><td>-0.5242855117710061</td><td>SER</td><td>2.170910622844513</td><td>0.7404346466064453</td><td>333.9393005371094</td><td>0.5321943163871765</td><td>4.550629206789836e-09</td><td>6.8587584500789944e-09</td><td>3.520021607528179e-08</td><td>6.720015477412744e-08</td><td>1.7618161507471086e-07</td><td>5.838797179080757e-08</td><td>3.523029690200019e-08</td><td>2.141273469646876e-08</td></tr>
<tr><td>271.4612060810417</td><td>0.48981218301356017</td><td>SER</td><td>3.9307805517506704</td><td>0.30752477049827576</td><td>114.4226303100586</td><td>0.26505595445632935</td><td>6.278863207143104e-09</td><td>6.867115764919163e-10</td><td>1.5396568464609572e-09</td><td>1.934612026133209e-09</td><td>4.098307027078363e-09</td><td>1.5311047985022697e-09</td><td>4.907185768843192e-09</td><td>1.902641377782288e-09</td></tr>
<tr><td>270.5213999343187</td><td>0.3768383558530194</td><td>SER</td><td>1.1385050100070848</td><td>0.8638880848884583</td><td>180.25221252441406</td><td>0.6406149864196777</td><td>2.1948302730834257e-07</td><td>1.7533350771259393e-08</td><td>2.676470600704306e-08</td><td>6.562089538419968e-08</td><td>2.8127658424637048e-08</td><td>1.7247877792669897e-08</td><td>1.6523750900887535e-07</td><td>2.2672709931725876e-08</td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr><td>270.85769202755245</td><td>0.773636140913735</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td><td>8.986796115574053e-08</td></tr>
<tr><td>270.8678714354956</td><td>0.7813771659605562</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td><td>2.9739923273900245e-08</td></tr>
<tr><td>270.8810884457293</td><td>0.7918143514923536</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td><td>1.0099146401647886e-08</td></tr>
<tr><td>270.92454702622655</td><td>0.7993537136787594</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td><td>6.088817097858871e-08</td></tr>
<tr><td>270.83084247667165</td><td>0.788319808618689</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td><td>2.9773849683440578e-08</td></tr>
<tr><td>270.8567519994558</td><td>0.7790670197665834</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td><td>1.2046944861879528e-08</td></tr>
<tr><td>270.8586204015057</td><td>0.7708144043522202</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td><td>6.308154822102114e-09</td></tr>
<tr><td>270.8727696686416</td><td>0.7881045599926982</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td><td>7.121531420844011e-09</td></tr>
<tr><td>270.85350681512693</td><td>0.789461511245047</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td><td>3.9139177455632116e-08</td></tr>
<tr><td>270.9061584399961</td><td>0.7992513585093951</td><td>PSF</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>-1.0</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td><td>1.1693905898571949e-07</td></tr>
</table></div></div></div>
</div>
<p>We can see galaxies at the top of the stacked catalog (notice type == “SER” for Sersic and values of n (the Sersic index) are not -1, while stars have type == PSF).</p>
<section id="image-simulation">
<h3>Image Simulation<a class="headerlink" href="#image-simulation" title="Link to this heading">#</a></h3>
<p>Here we show how to run the actual simulation using Roman I-Sim. The method for running the simulation for both L1 and L2 data is the same, so we will show an example for L2, and give instructions of how to modify this for L1.</p>
<p>In our example, we are simulating only a single image, so we have set the persistance to the default. Future updates may include how to simulate persistance from multiple exposures.</p>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>Roman I-Sim allows the user to either use reference files from CRDS or to use no reference files. The latter is not recommended.</p></li>
<li><p>Each detector is simulated separately. Below, in the <a class="reference internal" href="#Parallelized-Simulations"><span class="xref myst">Advanced Use Cases - Parallelized Simulations</span></a> section, we include instructions on how to parallelize the simulations using Dask.</p></li>
<li><p>Currently, the simulator does not include the effect of 1/f noise.</p></li>
<li><p>Multi-accumulation (MA) tables control the total exposure time and sampling up-the-ramp. For more information, see the <a class="reference external" href="https://roman-docs.stsci.edu/raug/astronomers-proposal-tool-apt/appendix/appendix-wfi-multiaccum-tables">MA table article</a> in the Roman APT Users Guide.</p></li>
</ul>
<p>In this case, we will create an observation using the detector WFI01 and the F106 optical element. The observation is simulated to occur at UTC time 2026-10-31T00:00:00 and an exposure time of approximately 60 seconds.</p>
<p><strong>Note:</strong> It will take several minutes to download the appropriate calibration reference files the first time this cell is run. Any changes to the settings below may require downloading additional files, which could increase the run time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs_date</span> <span class="o">=</span> <span class="s1">&#39;2026-10-31T00:00:00&#39;</span>  <span class="c1"># Datetime of the simulated exposure</span>
<span class="n">sca</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Change this number to simulate different WFI detectors 1 - 18</span>
<span class="n">optical_element</span> <span class="o">=</span> <span class="s1">&#39;F106&#39;</span>  <span class="c1"># Optical element to simulate</span>
<span class="n">ma_table_number</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Multi-accumulation (MA) table number (see RDox for more information)</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># Galsim random number generator seed for reproducibility</span>
<span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># WFI data level to simulate...1 or 2</span>
<span class="n">cal_level</span> <span class="o">=</span> <span class="s1">&#39;cal&#39;</span> <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;uncal&#39;</span>  <span class="c1"># File name extension for data calibration level</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;r0003201001001001004_0001_wfi</span><span class="si">{</span><span class="n">sca</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">optical_element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cal_level</span><span class="si">}</span><span class="s1">.asdf&#39;</span>  <span class="c1"># Output file name on disk. Only change the first part up to _WFI to change the rootname of the file.</span>

<span class="c1"># Set other arguments for use in Roman I-Sim. The code expects a specific format for these, so this is a little complicated looking.</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">usecrds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stpsf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">drop_extra_dq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="n">sca</span><span class="p">,</span> 
                    <span class="n">bandpass</span><span class="o">=</span><span class="n">optical_element</span><span class="p">,</span> <span class="n">pretend_spectral</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>

<span class="c1"># Set reference files to None for CRDS</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">reference_data</span><span class="p">:</span>
    <span class="n">parameters</span><span class="o">.</span><span class="n">reference_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Set Galsim RNG object</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">UniformDeviate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="c1"># Set default persistance information</span>
<span class="n">persist</span> <span class="o">=</span> <span class="n">persistence</span><span class="o">.</span><span class="n">Persistence</span><span class="p">()</span>

<span class="c1"># Set metadata</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">ris</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">obs_date</span><span class="p">,</span> <span class="n">bandpass</span><span class="o">=</span><span class="n">optical_element</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="n">sca</span><span class="p">,</span> <span class="n">ma_table_number</span><span class="o">=</span><span class="n">ma_table_number</span><span class="p">,</span> <span class="n">usecrds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Update the WCS info</span>
<span class="n">wcs</span><span class="o">.</span><span class="n">fill_in_parameters</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">boresight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pa_aper</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Run the simulation</span>
<span class="n">ris</span><span class="o">.</span><span class="n">simulate_image_file</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">full_catalog</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">persist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:44 INFO     Simulating filter F106...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:44 INFO     NumExpr defaulting to 4 threads.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     No source spectrum supplied, therefore defaulting to 5700 K blackbody
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Computing wavelength weights using synthetic photometry for F106...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     PSF calc using fov_arcsec = 5.000000, oversample = 4, number of wavelengths = 10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Creating optical system model:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Initialized OpticalSystem: Roman+WFI
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Roman Entrance Pupil: Loaded amplitude transmission from /home/runner/refdata/stpsf-data/WFI/pupils/RST_WIM_Filter_F106_WFI01.fits.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Roman Entrance Pupil: Loaded OPD from /home/runner/refdata/stpsf-data/upscaled_HST_OPD.fits
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Added pupil plane: Roman Entrance Pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Added coordinate inversion plane: OTE exit pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Added pupil plane: Field Dependent Aberration (WFI01)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Added detector with pixelscale=0.1078577405 and oversampling=4: WFI detector
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO     Calculating PSF with 10 wavelengths
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:49 INFO      Propagating wavelength = 9.4555e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:56 INFO      Propagating wavelength = 9.7265e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:57 INFO      Propagating wavelength = 9.9975e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:57 INFO      Propagating wavelength = 1.02685e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:58 INFO      Propagating wavelength = 1.05395e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:58 INFO      Propagating wavelength = 1.08105e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:59 INFO      Propagating wavelength = 1.10815e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:47:59 INFO      Propagating wavelength = 1.13525e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:00 INFO      Propagating wavelength = 1.16235e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:00 INFO      Propagating wavelength = 1.18945e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO       Calculation completed in 11.315 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     PSF Calculation completed.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Calculating jitter using gaussian
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Jitter: Convolving with Gaussian with sigma=0.012 arcsec
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO             resulting image peak drops to 0.946 of its previous value
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Detector charge diffusion not applied because charge_diffusion_sigma option is 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO      Adding extension with image downsampled to detector pixel scale.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     No source spectrum supplied, therefore defaulting to 5700 K blackbody
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Computing wavelength weights using synthetic photometry for F106...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     PSF calc using fov_arcsec = 5.000000, oversample = 4, number of wavelengths = 10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Creating optical system model:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Initialized OpticalSystem: Roman+WFI
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Roman Entrance Pupil: Loaded amplitude transmission from /home/runner/refdata/stpsf-data/WFI/pupils/RST_WIM_Filter_F106_WFI01.fits.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Roman Entrance Pupil: Loaded OPD from /home/runner/refdata/stpsf-data/upscaled_HST_OPD.fits
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Added pupil plane: Roman Entrance Pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Added coordinate inversion plane: OTE exit pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Added pupil plane: Field Dependent Aberration (WFI01)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Added detector with pixelscale=0.1078577405 and oversampling=4: WFI detector
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO     Calculating PSF with 10 wavelengths
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:01 INFO      Propagating wavelength = 9.4555e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:02 INFO      Propagating wavelength = 9.7265e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:02 INFO      Propagating wavelength = 9.9975e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:03 INFO      Propagating wavelength = 1.02685e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:03 INFO      Propagating wavelength = 1.05395e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:04 INFO      Propagating wavelength = 1.08105e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:04 INFO      Propagating wavelength = 1.10815e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:05 INFO      Propagating wavelength = 1.13525e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:05 INFO      Propagating wavelength = 1.16235e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:06 INFO      Propagating wavelength = 1.18945e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:06 INFO       Calculation completed in 5.162 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     PSF Calculation completed.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Calculating jitter using gaussian
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Jitter: Convolving with Gaussian with sigma=0.012 arcsec
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO             resulting image peak drops to 0.946 of its previous value
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Detector charge diffusion not applied because charge_diffusion_sigma option is 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO      Adding extension with image downsampled to detector pixel scale.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     No source spectrum supplied, therefore defaulting to 5700 K blackbody
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Computing wavelength weights using synthetic photometry for F106...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     PSF calc using fov_arcsec = 5.000000, oversample = 4, number of wavelengths = 10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Creating optical system model:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Initialized OpticalSystem: Roman+WFI
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Roman Entrance Pupil: Loaded amplitude transmission from /home/runner/refdata/stpsf-data/WFI/pupils/RST_WIM_Filter_F106_WFI01.fits.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Roman Entrance Pupil: Loaded OPD from /home/runner/refdata/stpsf-data/upscaled_HST_OPD.fits
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Added pupil plane: Roman Entrance Pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Added coordinate inversion plane: OTE exit pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Added pupil plane: Field Dependent Aberration (WFI01)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Added detector with pixelscale=0.1078577405 and oversampling=4: WFI detector
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO     Calculating PSF with 10 wavelengths
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:07 INFO      Propagating wavelength = 9.4555e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:08 INFO      Propagating wavelength = 9.7265e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:08 INFO      Propagating wavelength = 9.9975e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:09 INFO      Propagating wavelength = 1.02685e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:09 INFO      Propagating wavelength = 1.05395e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:10 INFO      Propagating wavelength = 1.08105e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:10 INFO      Propagating wavelength = 1.10815e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:11 INFO      Propagating wavelength = 1.13525e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:11 INFO      Propagating wavelength = 1.16235e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO      Propagating wavelength = 1.18945e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO       Calculation completed in 5.201 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO     PSF Calculation completed.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO     Calculating jitter using gaussian
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO     Jitter: Convolving with Gaussian with sigma=0.012 arcsec
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO             resulting image peak drops to 0.946 of its previous value
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO     Detector charge diffusion not applied because charge_diffusion_sigma option is 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO      Adding extension with image downsampled to detector pixel scale.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:12 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     No source spectrum supplied, therefore defaulting to 5700 K blackbody
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Computing wavelength weights using synthetic photometry for F106...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     PSF calc using fov_arcsec = 5.000000, oversample = 4, number of wavelengths = 10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Creating optical system model:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Initialized OpticalSystem: Roman+WFI
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Roman Entrance Pupil: Loaded amplitude transmission from /home/runner/refdata/stpsf-data/WFI/pupils/RST_WIM_Filter_F106_WFI01.fits.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Roman Entrance Pupil: Loaded OPD from /home/runner/refdata/stpsf-data/upscaled_HST_OPD.fits
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Added pupil plane: Roman Entrance Pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Added coordinate inversion plane: OTE exit pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Added pupil plane: Field Dependent Aberration (WFI01)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Added detector with pixelscale=0.1078577405 and oversampling=4: WFI detector
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO     Calculating PSF with 10 wavelengths
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO      Propagating wavelength = 9.4555e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:13 INFO      Propagating wavelength = 9.7265e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:14 INFO      Propagating wavelength = 9.9975e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:15 INFO      Propagating wavelength = 1.02685e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:15 INFO      Propagating wavelength = 1.05395e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:16 INFO      Propagating wavelength = 1.08105e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:16 INFO      Propagating wavelength = 1.10815e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:17 INFO      Propagating wavelength = 1.13525e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:17 INFO      Propagating wavelength = 1.16235e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO      Propagating wavelength = 1.18945e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO       Calculation completed in 5.114 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO     PSF Calculation completed.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO     Calculating jitter using gaussian
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO     Jitter: Convolving with Gaussian with sigma=0.012 arcsec
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO             resulting image peak drops to 0.946 of its previous value
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO     Detector charge diffusion not applied because charge_diffusion_sigma option is 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO      Adding extension with image downsampled to detector pixel scale.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:18 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:23 WARNING  max(flat) &gt; 1.1; this seems weird?!
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:48:23 INFO     Adding 1745 sources to image...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:49:48 INFO     Rendered 1745 sources...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:49:51 INFO     Apportioning electrons to resultants...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:21 INFO     Adding IPC...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:22 INFO     Adding read noise...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:26 INFO     Fitting ramps.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:32 INFO     Simulation complete.
</pre></div>
</div>
</div>
</div>
<p>If we want to simulate an L1 ramp cube, then we can change the level variable above to 1, which will also change the output file name to <code class="docutils literal notranslate"><span class="pre">*_uncal.asdf</span></code>. The rest of the information stays the same.</p>
</section>
</section>
<section id="advanced-use-cases">
<h2>Advanced Use Cases<a class="headerlink" href="#advanced-use-cases" title="Link to this heading">#</a></h2>
<section id="dithered-observations">
<h3>Dithered Observations<a class="headerlink" href="#dithered-observations" title="Link to this heading">#</a></h3>
<p>Dithering is the process of shifting the telescope position slightly such that astronomical sources fall on different pixel positions in consecutive observations. Dithers comes in two flavors:</p>
<ul class="simple">
<li><p>Large dithers: Used to fill the gaps between detectors and to reject pixels affected by undesirable effects</p></li>
<li><p>Sub-pixel dithers: Used for sampling the point spread function (PSF)</p></li>
</ul>
<p>If we want to create a set of dithered observations, we need to determine the new pointing of the WFI. Here we introduce a Python class that can take an initial right ascension, declination, and position angle of the WFI and then apply offsets to update those parameters for a new pointing. First, let’s import some new packages and modules that will help, specifically:</p>
<ul class="simple">
<li><p><em>pysiaf</em> for WFI coordinate transformations</p></li>
<li><p><em>dataclasses</em> for simplifying the definition of a class</p></li>
<li><p><em>typing</em> for type hinting of inputs and outputs</p></li>
</ul>
<p>In this section, we show you how to determine the pointing positions necessary for dithering with the Roman WFI. In the <a class="reference internal" href="#Simulating-Dithered-Observations-in-Parallel"><span class="xref myst">Advanced Use Cases - Simulating Dithered Observations in Parallel</span></a> section, we combine the dithering information and parallelization with Dask to show how to put this information to use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pysiaf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we create a Python class called <code class="docutils literal notranslate"><span class="pre">PointWFI</span></code> that takes three inputs: ra, dec, and roll_angle. Defining a class may be a little complicated for those who are new to Python, so don’t worry too much about the details for now. Just know that this class takes your input position, creates an attitude matrix for the spacecraft using PySIAF, applies the offsets, and updates the pointing information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PointWFI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    ra (float): Right ascension of the target placed at the geometric </span>
<span class="sd">                center of the Wide Field Instrument (WFI) focal plane</span>
<span class="sd">                array. This has units of degrees.</span>
<span class="sd">    dec (float): Declination of the target placed at the geometric</span>
<span class="sd">                 center of the WFI focal plane array. This has units</span>
<span class="sd">                 of degrees.</span>
<span class="sd">    position_angle (float): Position angle of the WFI relative to the V3 axis</span>
<span class="sd">                            measured from North to East. A value of 0.0 degrees</span>
<span class="sd">                            would place the WFI in the &quot;smiley face&quot; orientation</span>
<span class="sd">                            (U-shaped) on the celestial sphere. To place WFI</span>
<span class="sd">                            such that the position angle of the V3 axis is </span>
<span class="sd">                            zero degrees, use a WFI position angle of -60 degrees.</span>

<span class="sd">    Description</span>
<span class="sd">    -----------</span>
<span class="sd">    To use this class, insantiate it with your initial pointing like so:</span>

<span class="sd">        &gt;&gt;&gt; point = PointWFI(ra=30, dec=-45, position_angle=10)</span>
<span class="sd">    </span>
<span class="sd">    and then dither using the dither method:</span>

<span class="sd">        &gt;&gt;&gt; point.dither(x_offset=10, y_offset=140)</span>

<span class="sd">    This would shift the WFI 10 arcseconds along the X-axis of the WFI</span>
<span class="sd">    and 140 arcseconds along the Y-axis of the WFI. These axes are in the ideal</span>
<span class="sd">    coordinate system of the WFI, i.e, with the WFI oriented in a U-shape with </span>
<span class="sd">    +x to the right and +y up. You can pull the new pointing info out of the object </span>
<span class="sd">    either as attributes or by just printing the object:</span>

<span class="sd">        &gt;&gt;&gt; print(point.ra, point.dec)</span>
<span class="sd">        &gt;&gt;&gt; 29.95536280064078 -44.977122003232786</span>

<span class="sd">    or</span>

<span class="sd">        &gt;&gt;&gt; point</span>
<span class="sd">        &gt;&gt;&gt; PointWFI(ra=29.95536280064078, dec=-44.977122003232786, position_angle=10)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set default pointing parameters</span>
    <span class="n">ra</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">position_angle</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">60.0</span>

    <span class="c1"># Post init method sets some other defaults and initializes</span>
    <span class="c1"># the attitude matrix using PySIAF.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">siaf_aperture</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">Siaf</span><span class="p">(</span><span class="s1">&#39;Roman&#39;</span><span class="p">)[</span><span class="s1">&#39;WFI_CEN&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siaf_aperture</span><span class="o">.</span><span class="n">V2Ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v3_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siaf_aperture</span><span class="o">.</span><span class="n">V3Ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attitude_matrix</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rotations</span><span class="o">.</span><span class="n">attitude</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v2_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3_ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">siaf_aperture</span><span class="o">.</span><span class="n">set_attitude_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attitude_matrix</span><span class="p">)</span>

        <span class="c1"># Compute the V3 position angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tel_roll</span> <span class="o">=</span> <span class="n">pysiaf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rotations</span><span class="o">.</span><span class="n">posangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attitude_matrix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Save initial pointing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">att0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attitude_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Save a copy of the input RA and Dec in case someone needs it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dither</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_offset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
               <span class="n">y_offset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Purpose</span>
<span class="sd">        -------</span>
<span class="sd">        Take in an ideal X and Y offset in arcseconds and shift the telescope</span>
<span class="sd">        pointing to that position.</span>

<span class="sd">        Inputs</span>
<span class="sd">        ------</span>
<span class="sd">        x_offset (float): The offset in arcseconds in the ideal X direction.</span>

<span class="sd">        y_offset (float): The offset in arcseconds in the ideal Y direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">siaf_aperture</span><span class="o">.</span><span class="n">idl_to_sky</span><span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s dither the WFI. We will use the BOXGAP4 dither pattern for our example. See the RDox article on <a class="reference external" href="https://roman-docs.stsci.edu/roman-instruments-home/wfi-imaging-mode-user-guide/observing-with-the-wfi-in-imaging-mode/wfi-dithering">WFI Dithering</a> for more information. Note that the dither offsets are represented in the ideal X and Y directions (this means that +X is to the right and +Y is up when the WFI is in the U-shaped orientation with WFI07 and WFI16 in the upper-right and upper-left corners, respectively). The offsets are in units of arcseconds, and each offset represents the offset from the initial starting position. Here is the pattern:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Dither Step</p></th>
<th class="head"><p>Offset X (arcsec)</p></th>
<th class="head"><p>Offset Y (arcsec)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0.00</p></td>
<td><p>0.00</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>-205.20</p></td>
<td><p>0.88</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>-204.32</p></td>
<td><p>206.08</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>0.88</p></td>
<td><p>205.20</p></td>
</tr>
</tbody>
</table>
</div>
<p>Now let’s instantiate the <code class="docutils literal notranslate"><span class="pre">PointWFI</span></code> object with our initial pointing and move to the first dither position:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pointing</span> <span class="o">=</span> <span class="n">PointWFI</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">270.7</span><span class="p">,</span> <span class="n">dec</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">position_angle</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">pointing</span><span class="o">.</span><span class="n">dither</span><span class="p">(</span><span class="n">x_offset</span><span class="o">=-</span><span class="mf">205.20</span><span class="p">,</span> <span class="n">y_offset</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pointing</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PointWFI(ra=np.float64(270.7282882327223), dec=np.float64(-0.15051433561208868), position_angle=0.0)
</pre></div>
</div>
</div>
</div>
<p>We can see that the WFI shifted slightly in both right ascension and declination, but not by -205.20 and +0.88 arcseconds. Remember that the WFI dither offsets are specified in a coordinate system local to the WFI, so the offsets on the sky will be different (hence the need for the class we created above). To make it easier to script our simulations, we can pull the variables out of the <code class="docutils literal notranslate"><span class="pre">pointing</span></code> object, such as below where we show how to retrieve the <code class="docutils literal notranslate"><span class="pre">.ra</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pointing</span><span class="o">.</span><span class="n">ra</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(270.7282882327223)
</pre></div>
</div>
</div>
</div>
</section>
<section id="parallelized-simulations">
<h3>Parallelized Simulations<a class="headerlink" href="#parallelized-simulations" title="Link to this heading">#</a></h3>
<p>Often, we will want to run a simulation using multiple detectors rather than just one at a time. Looping over the above in a serial fashion can take quite a long time, so we want to parallelize the work. In the example below, we will show how to parallelize the procedure with <code class="docutils literal notranslate"><span class="pre">Dask</span></code>. These cells are commented out by default, so to run them you need to uncomment all of the lines. Comments in code cells are marked with two # symbols (e.g., <code class="docutils literal notranslate"><span class="pre">##</span> <span class="pre">Comment</span></code>), so be sure to remove only the leading single # symbol.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>dask<span class="o">[</span>complete<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: dask[complete] in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (2025.11.0)
Requirement already satisfied: click&gt;=8.1 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (8.3.1)
Requirement already satisfied: cloudpickle&gt;=3.0.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (3.1.2)
Requirement already satisfied: fsspec&gt;=2021.09.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (2025.12.0)
Requirement already satisfied: packaging&gt;=20.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (25.0)
Requirement already satisfied: partd&gt;=1.4.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (1.4.2)
Requirement already satisfied: pyyaml&gt;=5.3.1 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (6.0.3)
Requirement already satisfied: toolz&gt;=0.10.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (1.1.0)
Requirement already satisfied: pyarrow&gt;=14.0.1 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (22.0.0)
Requirement already satisfied: lz4&gt;=4.3.2 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (4.4.5)
Requirement already satisfied: locket in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from partd&gt;=1.4.0-&gt;dask[complete]) (1.0.0)
Requirement already satisfied: numpy&gt;=1.24 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (2.3.5)
Requirement already satisfied: pandas&gt;=2.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (2.3.3)
Requirement already satisfied: distributed==2025.11.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (2025.11.0)
Requirement already satisfied: bokeh&gt;=3.1.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (3.8.1)
Requirement already satisfied: jinja2&gt;=2.10.3 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from dask[complete]) (3.1.6)
Requirement already satisfied: msgpack&gt;=1.0.2 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (1.1.2)
Requirement already satisfied: psutil&gt;=5.8.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (7.1.3)
Requirement already satisfied: sortedcontainers&gt;=2.0.5 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (2.4.0)
Requirement already satisfied: tblib&gt;=1.6.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (3.2.2)
Requirement already satisfied: tornado&gt;=6.2.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (6.5.3)
Requirement already satisfied: urllib3&gt;=1.26.5 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (2.6.1)
Requirement already satisfied: zict&gt;=3.0.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from distributed==2025.11.0-&gt;dask[complete]) (3.0.0)
Requirement already satisfied: contourpy&gt;=1.2 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from bokeh&gt;=3.1.0-&gt;dask[complete]) (1.3.3)
Requirement already satisfied: narwhals&gt;=1.13 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from bokeh&gt;=3.1.0-&gt;dask[complete]) (2.13.0)
Requirement already satisfied: pillow&gt;=7.1.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from bokeh&gt;=3.1.0-&gt;dask[complete]) (12.0.0)
Requirement already satisfied: xyzservices&gt;=2021.09.1 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from bokeh&gt;=3.1.0-&gt;dask[complete]) (2025.11.0)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from jinja2&gt;=2.10.3-&gt;dask[complete]) (3.0.3)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: python-dateutil&gt;=2.8.2 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from pandas&gt;=2.0-&gt;dask[complete]) (2.9.0.post0)
Requirement already satisfied: pytz&gt;=2020.1 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from pandas&gt;=2.0-&gt;dask[complete]) (2025.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from pandas&gt;=2.0-&gt;dask[complete]) (2025.2)
Requirement already satisfied: six&gt;=1.5 in /home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages (from python-dateutil&gt;=2.8.2-&gt;pandas&gt;=2.0-&gt;dask[complete]) (1.17.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
</pre></div>
</div>
</div>
</div>
<p>At this point, it’s helpful to redefine our simulation call above as a single function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_romanisim</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">obs_date</span> <span class="o">=</span> <span class="s1">&#39;2026-10-31T00:00:00&#39;</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">expnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">optical_element</span><span class="o">=</span><span class="s1">&#39;F106&#39;</span><span class="p">,</span> 
                  <span class="n">ma_table_number</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;r0003201001001001004&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">5346</span><span class="p">):</span>

    <span class="n">cal_level</span> <span class="o">=</span> <span class="s1">&#39;cal&#39;</span> <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;uncal&#39;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">expnum</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">_wfi</span><span class="si">{</span><span class="n">sca</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">optical_element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cal_level</span><span class="si">}</span><span class="s1">.asdf&#39;</span>

    <span class="c1"># Set other arguments for use in Roman I-Sim. The code expects a specific format for these, so this is a little complicated looking.</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">usecrds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stpsf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">drop_extra_dq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="n">sca</span><span class="p">,</span> 
                        <span class="n">bandpass</span><span class="o">=</span><span class="n">optical_element</span><span class="p">,</span> <span class="n">pretend_spectral</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([])</span>

    <span class="c1"># Set reference files to None for CRDS</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">reference_data</span><span class="p">:</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">reference_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Set Galsim RNG object</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">UniformDeviate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Set default persistance information</span>
    <span class="n">persist</span> <span class="o">=</span> <span class="n">persistence</span><span class="o">.</span><span class="n">Persistence</span><span class="p">()</span>

    <span class="c1"># Set metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ris</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">obs_date</span><span class="p">,</span> <span class="n">bandpass</span><span class="o">=</span><span class="n">optical_element</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="n">sca</span><span class="p">,</span> <span class="n">ma_table_number</span><span class="o">=</span><span class="n">ma_table_number</span><span class="p">,</span> <span class="n">usecrds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Update the WCS info</span>
    <span class="n">wcs</span><span class="o">.</span><span class="n">fill_in_parameters</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">),</span> <span class="n">boresight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pa_aper</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Run the simulation</span>
    <span class="n">sim_result</span> <span class="o">=</span> <span class="n">ris</span><span class="o">.</span><span class="n">simulate_image_file</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">persist</span><span class="p">)</span>

    <span class="c1"># Clean up the memory</span>
    <span class="k">del</span> <span class="n">sim_result</span>
</pre></div>
</div>
</div>
</div>
<p>Now we initialize the Dask <code class="docutils literal notranslate"><span class="pre">Client()</span></code> and pass our simulation jobs to it. Dask will take care of scheduling the jobs and allocating resources. That said, we do have to be careful to not overload the Client. Set the number of WFI detectors to be simulated in the for loop appropriately to <code class="docutils literal notranslate"><span class="pre">n_detectors</span> <span class="pre">=</span> <span class="pre">3</span></code> for a large RRN server.</p>
<p>The variable <code class="docutils literal notranslate"><span class="pre">offset</span></code> adds an offset to the numbering of the WFI detector names. If you want to simulate, e.g., detectors WFI01, WFI02, and WFI03, then set <code class="docutils literal notranslate"><span class="pre">n_detectors</span> <span class="pre">=</span> <span class="pre">3</span></code> and <code class="docutils literal notranslate"><span class="pre">offset</span> <span class="pre">=</span> <span class="pre">0</span></code>. If instead you want to simulate, e.g., detectors WFI04, WFI05, and WFI06, then set <code class="docutils literal notranslate"><span class="pre">n_detectors</span> <span class="pre">=</span> <span class="pre">3</span></code> and <code class="docutils literal notranslate"><span class="pre">offset</span> <span class="pre">=</span> <span class="pre">3</span></code>. The <code class="docutils literal notranslate"><span class="pre">expnum</span></code> variable lets you change the exposure number in the file name (this is useful if you are simulated a series of dithered observations).</p>
<p><strong>WARNING:</strong> Please be cautious when parallelizing tasks such as Roman I-Sim as it can easily consume all of your RRN resources if handled incorrectly!</p>
<p>We have commented out the lines below. If you want to run the parallelized simulation, uncomment all of the lines in the following code cell.</p>
<p><strong>Note:</strong> This cell may take several minutes to run. In addition, logging messages from <code class="docutils literal notranslate"><span class="pre">romanisim</span></code> and its dependencies will appear cluttered as they are executing simultaneously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Number of detectors to simulate. Change offset to select</span>
<span class="c1">## higher detector IDs (e.g., n_detectors = 3 and offset = 3</span>
<span class="c1">## will simulate detectors WFI04, WFI05, and WFI06.</span>
<span class="c1">#n_detectors = 3</span>
<span class="c1">#offset = 0</span>
<span class="c1">#</span>
<span class="c1">## Change this to increment the exposure number in the simulation output filename</span>
<span class="c1">#expnum = 1</span>

<span class="c1">## Set up Dask client</span>
<span class="c1">## Give each simulation call its own worker so that no one worker exceeds</span>
<span class="c1">## the allocated memory.</span>
<span class="c1">#dask_client = Client(n_workers=n_detectors)</span>
<span class="c1">#</span>
<span class="c1">## Create simulation runs to send to the client</span>
<span class="c1">#tasks = []</span>
<span class="c1">#for i in range(n_detectors):</span>
<span class="c1">#</span>
<span class="c1">#    # Create simulations with the full_catalog defined above and for 3</span>
<span class="c1">#    # WFI detectors. Otherwise, use the default parameters.</span>
<span class="c1">#    tasks.append(dask_client.submit(run_romanisim, full_catalog, **{&#39;ra&#39;: pointing.ra, &#39;dec&#39;: pointing.dec, &#39;sca&#39;: i+1+offset, &#39;expnum&#39;: expnum}))</span>
<span class="c1">#</span>
<span class="c1">## Wait for all tasks to complete</span>
<span class="c1">#results = dask_client.gather(tasks)</span>
<span class="c1">#</span>
<span class="c1">## Don&#39;t forget to close the Dask client!</span>
<span class="c1">#dask_client.close()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="simulating-dithered-observations-in-parallel">
<h3>Simulating Dithered Observations in Parallel<a class="headerlink" href="#simulating-dithered-observations-in-parallel" title="Link to this heading">#</a></h3>
<p>Now that we have demonstrated how to determine the WFI pointing positions necessary for any dither pattern, and how to parallelize Roman I-Sim simulations to simulate multiple detectors simultaneously, let’s combine that information to simulate a series of dithered observations. As in the <a class="reference internal" href="#Parallelized-Simulations"><span class="xref myst">Advanced Use Cases - Parallelized Simulations</span></a> section, we have commented out all of the code cells below.</p>
<p><strong>Note:</strong> If you have not reviewed the <a class="reference internal" href="#Parallelized-Simulations"><span class="xref myst">Advanced Use Cases - Parallelized Simulations</span></a> section, please review the information in that part of the tutorial before proceeding. At a minimum, you will need to install Dask and define the Roman I-Sim wrapper function before running the cells below.</p>
<p>We will use the four-point box gap-filling dither pattern described in <a class="reference internal" href="#Dithered-Observations"><span class="xref myst">Advanced Use Cases - Dithered Observations</span></a>. We will also re-use the Roman I-Sim wrapper function that we defined for Dask. As you can see in the cell below, we are simulating three WFI detectors at a time at each dither position before proceeding to the next dither position. At each dither position, we incrementally update the exposure number. The resulting file names are: <code class="docutils literal notranslate"><span class="pre">r0003201001001001004_XXXX_wfiNN_f106_uncal.asdf</span></code>, where XXXX is the zero-padded exposure number (e.g., 0001) and NN is the WFI detector ID (e.g., WFI01). Note that these are L1 files rather than the L2 file that was simulated previously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Initial pointing</span>
<span class="c1">#pointing = PointWFI(ra=270.94, dec=-0.2, position_angle=0.0)</span>
<span class="c1">#</span>
<span class="c1">## Number of detectors to simulate. Change offset to select</span>
<span class="c1">## higher detector IDs (e.g., n_detectors = 3 and offset = 3</span>
<span class="c1">## will simulate detectors WFI04, WFI05, and WFI06.</span>
<span class="c1">#n_detectors = 3</span>
<span class="c1">#offset = 0</span>
<span class="c1">#</span>
<span class="c1">## Change this to increment the exposure number in the simulation output filename</span>
<span class="c1">#expnum = 1</span>
<span class="c1">#</span>
<span class="c1">## Set up Dask client</span>
<span class="c1">## Give each simulation call its own worker so that no one worker exceeds</span>
<span class="c1">## the allocated memory.</span>
<span class="c1">#dask_client = Client(n_workers=n_detectors)</span>
<span class="c1">#</span>
<span class="c1">## Create simulation runs to send to the client</span>
<span class="c1">#tasks = []</span>
<span class="c1">#for i in range(n_detectors):</span>
<span class="c1">#</span>
<span class="c1">#    # Create simulations with the full_catalog defined above and for 3</span>
<span class="c1">#    # WFI detectors. Otherwise, use the default parameters.</span>
<span class="c1">#    tasks.append(dask_client.submit(run_romanisim, full_catalog, **{&#39;ra&#39;: pointing.ra, &#39;dec&#39;: pointing.dec, &#39;sca&#39;: i+1+offset, &#39;expnum&#39;: expnum, &#39;level&#39;: 1}))</span>
<span class="c1">#</span>
<span class="c1">## Wait for all tasks to complete</span>
<span class="c1">#results = dask_client.gather(tasks)</span>
<span class="c1">#</span>
<span class="c1">## Exposure 2</span>
<span class="c1">## Dither -205.20 +0.88</span>
<span class="c1">#pointing.dither(x_offset=-205.20, y_offset=0.88)</span>
<span class="c1">#expnum=2</span>
<span class="c1">#tasks = []</span>
<span class="c1">#for i in range(n_detectors):</span>
<span class="c1">#    tasks.append(dask_client.submit(run_romanisim, full_catalog, **{&#39;ra&#39;: pointing.ra, &#39;dec&#39;: pointing.dec, &#39;sca&#39;: i+1+offset, &#39;expnum&#39;: expnum, &#39;level&#39;: 1}))</span>
<span class="c1">#</span>
<span class="c1">## Wait for all tasks to complete</span>
<span class="c1">#results = dask_client.gather(tasks)</span>
<span class="c1">#</span>
<span class="c1">## Exposure 3</span>
<span class="c1">## Dither -204.32 +206.08</span>
<span class="c1">#pointing.dither(x_offset=-204.32, y_offset=206.08)</span>
<span class="c1">#expnum=3</span>
<span class="c1">#tasks = []</span>
<span class="c1">#for i in range(n_detectors):</span>
<span class="c1">#    tasks.append(dask_client.submit(run_romanisim, full_catalog, **{&#39;ra&#39;: pointing.ra, &#39;dec&#39;: pointing.dec, &#39;sca&#39;: i+1+offset, &#39;expnum&#39;: expnum, &#39;level&#39;: 1}))</span>
<span class="c1">#</span>
<span class="c1">## Wait for all tasks to complete</span>
<span class="c1">#results = dask_client.gather(tasks)</span>
<span class="c1">#</span>
<span class="c1">## Exposure 4</span>
<span class="c1">## Dither +0.88 +205.20</span>
<span class="c1">#pointing.dither(x_offset=0.88, y_offset=205.20)</span>
<span class="c1">#expnum=4</span>
<span class="c1">#tasks = []</span>
<span class="c1">#for i in range(n_detectors):</span>
<span class="c1">#    tasks.append(dask_client.submit(run_romanisim, full_catalog, **{&#39;ra&#39;: pointing.ra, &#39;dec&#39;: pointing.dec, &#39;sca&#39;: i+1+offset, &#39;expnum&#39;: expnum, &#39;level&#39;: 1}))</span>
<span class="c1">#    </span>
<span class="c1">## Wait for all tasks to complete</span>
<span class="c1">#results = dask_client.gather(tasks)</span>
<span class="c1">#</span>
<span class="c1">## Don&#39;t forget to close the Dask client!</span>
<span class="c1">#dask_client.close()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="injecting-sources-into-l2-images">
<h3>Injecting Sources into L2 Images<a class="headerlink" href="#injecting-sources-into-l2-images" title="Link to this heading">#</a></h3>
<p>Another advanced use case is injecting sources into L2 images. This may be useful, for example, to assess completeness and to test systematics in our data (simulated or otherwise). We can also use this for creating time-variable sources in a series of simulations. Right now, Roman I-Sim only supports injection at L2, though work is underway to add this capability for L1 images in the future.</p>
<p>To inject sources into a L2 image, we need to create a Roman I-Sim input catalog. However, the catalog will be a shortened version containing just the sources that we want to inject. Also recall that the catalog brightnesses are specified in units of maggies, which are defined such that one maggie is equal to the reference AB magnitude flux (3,631 Jy), i.e., maggies $\equiv 10^{-0.4m_{\mathrm{AB}}}$.</p>
<p>First, let’s read in a L2 file and display it. We will use one of the images we just simulated, but after it has been run through the Exposure Pipeline to generate the L2 file. You can either visit the <a class="reference internal" href="../exposure_pipeline/exposure_pipeline.html"><span class="std std-doc">Exposure Pipeline</span></a> tutorial for more information to do this yourself, or use one of the files in the Nexus S3 bucket.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Stream the files from the S3 bucket if they are not in local storage</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;r0003201001001001004_0001_wfi01_f106_cal.asdf&#39;</span><span class="p">):</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r0003201001001001004_0001_wfi01_f106_cal.asdf&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">asdf_dir_uri</span> <span class="o">=</span> <span class="s1">&#39;s3://stpubdata/roman/nexus/soc_simulations/tutorial_data/&#39;</span>
    <span class="n">asdf_file_uri</span> <span class="o">=</span> <span class="n">asdf_dir_uri</span> <span class="o">+</span> <span class="s1">&#39;r0003201001001001004_0001_wfi01_f106_cal.asdf&#39;</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">asdf_file_uri</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">af</span> <span class="o">=</span> <span class="n">asdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">af</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s take a look at our image around some area we would like to inject a new source. For this, let’s choose pixel (X, Y) = (1000, 1000) to be the position of our new source, so we will display the area around that pixel. For more information on how to visualize your data, see the <a class="reference internal" href="#../data_visualization/data_visualization.ipynb"><span class="xref myst">Data Visualization</span></a> tutorial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a834a16de0909477d8545245a27a8f8df7e40ad4133ebbd75de1163a39aaabc4.png" src="../../_images/a834a16de0909477d8545245a27a8f8df7e40ad4133ebbd75de1163a39aaabc4.png" />
</div>
</div>
<p>Next, let’s create our catalog. Let’s choose a brightness of 2 x 10<sup>-8</sup> maggies (~19.25 AB magnitudes) for our source. Note that if you are injecting galaxies, then you will also need to supply the other parameters Roman I-Sim needs for galaxy sources (e.g., Sérsic index and half-light radius).</p>
<p>In the next cell, we make a function for creating and saving our injection catalog:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a function to create the catalog for sources</span>
<span class="c1"># that we want to inject into our L2 image.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_cat</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;injection_cat.ecsv&#39;</span><span class="p">):</span>

    <span class="n">filtlist</span> <span class="o">=</span> <span class="s1">&#39;F062 F087 F106 F129 F146 F158 F184 F213&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    <span class="n">src_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;PSF&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ra</span><span class="p">])</span>
    <span class="n">tab</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_types</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fluxes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">filtlist</span><span class="p">:</span>
            <span class="n">tab</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incorrect filter name </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

    <span class="n">tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And now run the function with our inputs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the RA and Dec from the WCS</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Make the injection catalog</span>
<span class="n">make_cat</span><span class="p">([</span><span class="n">ra</span><span class="p">],</span> <span class="p">[</span><span class="n">dec</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;F106&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2e-8</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the catalog we just created and make sure it looks correct:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;injection_cat.ecsv&#39;</span><span class="p">)</span>
<span class="n">tab</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>Table length=1</i>
<table id="table139914097909040" class="table-striped table-bordered table-condensed">
<thead><tr><th>ra</th><th>dec</th><th>type</th><th>F106</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>str3</th><th>float64</th></tr></thead>
<tr><td>270.904026679121</td><td>-0.19579469786176076</td><td>PSF</td><td>2e-08</td></tr>
</table></div></div></div>
</div>
<p>Previously in this tutorial, we wrote a function to run Roman I-Sim. In that function, we overrode all of the default parameters and set them to <code class="docutils literal notranslate"><span class="pre">None</span></code> to force Roman I-Sim to use calibration reference files from CRDS rather than the Roman I-Sim default scalar values. These default scalar values are intended to allow Roman I-Sim to in an offline mode when you may not have access to a CRDS cache or the CRDS server. However, the current version of the <code class="docutils literal notranslate"><span class="pre">inject_sources_into_l2()</span></code> function does not use CRDS reference files and must use the Roman I-Sim defaults. Because the injection needs the default parameter values, we need to restore them here. We accomplish that using Python’s <code class="docutils literal notranslate"><span class="pre">importlib.reload()</span></code> function to reload the installed version of <code class="docutils literal notranslate"><span class="pre">romanisim.parameters</span></code> into memory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;module &#39;romanisim.parameters&#39; from &#39;/home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages/romanisim/parameters.py&#39;&gt;
</pre></div>
</div>
</div>
</div>
<p>Now we run the source injection function <code class="docutils literal notranslate"><span class="pre">inject_sources_into_l2()</span></code> with our image (datamodel), the injection catalog (the variable <code class="docutils literal notranslate"><span class="pre">tab</span></code>), and we set <code class="docutils literal notranslate"><span class="pre">stpsf=True</span></code> to use STPSF-generated point spread functions (PSFs) for the simulation. Notice that we make a copy of the image using the <code class="docutils literal notranslate"><span class="pre">.copy()</span></code> method so that we inject the source into a copy of the image rather than the original. This lets us compare the original and the updated version after we inject the source.</p>
<p>As a reminder, this will use the default Roman I-Sim parameter values for the injected source; however, perhaps the most critical parameter (the gain) can be modified in the function call. The gain is important in the simulation as the WFI zeropoints in the L2 metadata are intended to transform from DN/s to MJy/sr, and therefore contain a factor of the gain. If needed, the gain value used in the zeropoint can be found in the photom reference file. In the cell below, we will set the gain to the default value (2 e<sup>–</sup>/DN) to demonstrate the proper way to modify the value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">inject_sources_into_l2</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">tab</span><span class="p">,</span> <span class="n">stpsf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">electron</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">DN</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:35 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:35 INFO     Using pupil mask &#39;F062&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:35 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     No source spectrum supplied, therefore defaulting to 5700 K blackbody
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Computing wavelength weights using synthetic photometry for F106...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Using pupil mask &#39;F106&#39; and detector &#39;WFI01&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     PSF calc using fov_arcsec = 5.000000, oversample = 4, number of wavelengths = 10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Creating optical system model:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Initialized OpticalSystem: Roman+WFI
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Roman Entrance Pupil: Loaded amplitude transmission from /home/runner/refdata/stpsf-data/WFI/pupils/RST_WIM_Filter_F106_WFI01.fits.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Roman Entrance Pupil: Loaded OPD from /home/runner/refdata/stpsf-data/upscaled_HST_OPD.fits
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Added pupil plane: Roman Entrance Pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Added coordinate inversion plane: OTE exit pupil
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Added pupil plane: Field Dependent Aberration (WFI01)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Added detector with pixelscale=0.1078577405 and oversampling=4: WFI detector
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO     Calculating PSF with 10 wavelengths
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:36 INFO      Propagating wavelength = 9.4555e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:37 INFO      Propagating wavelength = 9.7265e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:37 INFO      Propagating wavelength = 9.9975e-07 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:38 INFO      Propagating wavelength = 1.02685e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:38 INFO      Propagating wavelength = 1.05395e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:39 INFO      Propagating wavelength = 1.08105e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:39 INFO      Propagating wavelength = 1.10815e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:40 INFO      Propagating wavelength = 1.13525e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:40 INFO      Propagating wavelength = 1.16235e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO      Propagating wavelength = 1.18945e-06 m
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO       Calculation completed in 5.180 s
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO     PSF Calculation completed.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO     Calculating jitter using gaussian
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO     Jitter: Convolving with Gaussian with sigma=0.012 arcsec
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO             resulting image peak drops to 0.946 of its previous value
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO     Detector charge diffusion not applied because charge_diffusion_sigma option is 0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO      Adding extension with image downsampled to detector pixel scale.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:41 INFO      Downsampling to detector pixel scale, by 4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:42 INFO     Adding 1 sources to image...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:42 INFO     Rendered 1 sources...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:50:42 INFO     Fitting ramps.
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s re-plot the same region as before to show the injected source:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> 
              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
              <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">,</span> <span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> 
              <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
              <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1100</span><span class="p">])</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Injected&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/66e6d24ad633af17d7388ca03ecea9d72158acf05c3f2ee1138ef77212e026f0.png" src="../../_images/66e6d24ad633af17d7388ca03ecea9d72158acf05c3f2ee1138ef77212e026f0.png" />
</div>
</div>
</section>
</section>
<section id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://romanisim.readthedocs.io/en/latest/index.html">Roman I-Sim Documentation</a></p></li>
<li><p><a class="reference external" href="https://roman-pipeline.readthedocs.io/en/latest/index.html">RomanCal Documentation</a></p></li>
<li><p><a class="reference external" href="https://roman-docs.stsci.edu">Roman Documentation System (RDox)</a></p></li>
</ul>
</section>
<hr class="docutils" />
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Link to this heading">#</a></h2>
<p><strong>Author:</strong> Sanjib Sharma, Tyler Desjardins<br />
<strong>Updated On:</strong> 2025-12-04</p>
<table width="100%" style="border:none; border-collapse:collapse;">
  <tr style="border:none;">
    <td style="border:none; width:180px; white-space:nowrap;">
       <a href="#top" style="text-decoration:none; color:#0066cc;">↑ Top of page</a> 
    </td>
    <td style="border:none; text-align:center;">
       <img src="../../roman_logo.png" width="50">
    </td>
    <td style="border:none; text-align:right;">
       <img src="../../stsci_logo2.png" width="90">
    </td>
  </tr>
</table></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/roman_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/romanisim"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../working_with_asdf/working_with_asdf.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">How to Open Roman Data Files (ASDF)</p>
      </div>
    </a>
    <a class="right-next"
       href="../exposure_pipeline/exposure_pipeline.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Calibrating WFI Exposures with RomanCal</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nexus-server-information">Nexus Server Information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-information-and-read-only-status">Kernel Information and Read-Only Status</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-data">Reference Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#local-run-settings">Local Run Settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-the-roman-research-nexus">On the Roman Research Nexus</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-data">Tutorial Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#source-catalog-generation">Source Catalog Generation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-simulation">Image Simulation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-use-cases">Advanced Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dithered-observations">Dithered Observations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parallelized-simulations">Parallelized Simulations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulating-dithered-observations-in-parallel">Simulating Dithered Observations in Parallel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#injecting-sources-into-l2-images">Injecting Sources into L2 Images</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>