
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Calibrating WFI Exposures with RomanCal &#8212; STScI Roman Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/exposure_pipeline/exposure_pipeline';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Visualization of Roman APT products" href="../footprint_visualization/footprint_visualization.html" />
    <link rel="prev" title="Roman Research Nexus Data Discovery and Access in the Cloud" href="../data_discovery_and_access/data_discovery_and_access.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI Roman Notebooks - Home"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI Roman Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Nancy Grace Roman Space Telescope Notebooks
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/aperture_photometry.html">Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background_visualization_tool/RBVT.html">The Roman Background Visualization Tool (RBVT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_discovery_and_access/data_discovery_and_access.html">Roman Research Nexus Data Discovery and Access in the Cloud</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Calibrating WFI Exposures with RomanCal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../footprint_visualization/footprint_visualization.html">Visualization of Roman APT products</a></li>

<li class="toctree-l1"><a class="reference internal" href="../grism_spectral_extraction/grism_spectral_extraction.html">Roman Spectroscopy: Grism Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../measuring_galaxy_shapes/measuring_galaxy_shapes.html">Measuring Galaxy Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rist/rist.html">The Roman Interactive Sensitivity Tool (RIST)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../romanisim/romanisim.html">Simulating WFI Imaging Data with Roman I-Sim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stips/stips.html">STIPS Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stpsf/stpsf.html">STPSF Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../synphot/synphot.html">Roman WFI Synthetic Photometry with synphot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_asdf/working_with_asdf.html">How to Open Roman Data Files (ASDF)</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/roman_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/roman_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/exposure_pipeline/exposure_pipeline.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/exposure_pipeline/exposure_pipeline.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Calibrating WFI Exposures with RomanCal</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-information-and-read-only-status">Kernel Information and Read-Only Status <a id="top"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#local-run-settings">Local Run Settings</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-calibration-reference-data-system-crds">The Calibration Reference Data System (CRDS)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-data">Tutorial Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-elp-on-l1-data">Running the ELP on L1 Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-example-full-pipeline">Basic Example: Full Pipeline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-example-running-individual-pipeline-steps">Advanced Example: Running Individual Pipeline Steps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-files">Reference Files</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bad-pixel-masks">Bad Pixel Masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#darks">Darks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flats">Flats</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-reference-files">Retrieving Reference Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#crds-mapping-files">CRDS Mapping Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-a-file-by-name">Download a File by Name</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-reference-files">Examining Reference Files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-override-romancal-with-local-reference-files">How to Override RomanCal with Local Reference Files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="calibrating-wfi-exposures-with-romancal">
<h1>Calibrating WFI Exposures with RomanCal<a class="headerlink" href="#calibrating-wfi-exposures-with-romancal" title="Link to this heading">#</a></h1>
<section id="kernel-information-and-read-only-status">
<h2>Kernel Information and Read-Only Status <a id="top"></a><a class="headerlink" href="#kernel-information-and-read-only-status" title="Link to this heading">#</a></h2>
<p>To run this notebook, please select the “Roman Calibration” kernel at the top right of your window.
This notebook is read-only. You can run cells and make edits, but you must save changes to a different location. We recommend saving the notebook within your home directory, or to a new folder within your home (e.g. <span style="font-variant:small-caps;">file &gt; save notebook as &gt; my-nbs/nb.ipynb</span>). Note that a directory must exist before you attempt to add a notebook to it.</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>The purpose of this notebook is to calibrate Level 1 (L1; uncalibrated ramp cube) data with the Roman WFI science calibration pipeline RomanCal (Python package name <code class="docutils literal notranslate"><span class="pre">romancal</span></code>) to produce Level 2 (L2; calibrated rate image) exposure level data. To learn more, please visit the <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/roman-stsci-data-pipelines/exposure-level-pipeline">RDox pages on the Exposure Level Pipeline</a> (ELP). We also discuss calibration reference files including how to access and examine them and how to run the pipeline with custom reference files.</p>
<p>Details about the Roman data levels, including file naming conventions and file array names and data types, can be found in the RDox article <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/wfi-data-format/data-levels-and-products">Data Levels and Products</a>.</p>
<p>A L1 file contains uncalibrated ramps in units of Data Numbers (DN).  L1 files are three-dimensional data cubes, one dimension for time and two dimensions for image coordinates, that are shaped as  arrays with (N resultants, 4096 image rows, 4096 image columns). For a given pixel, a resultant contains either one read or the arithmetic mean of multiple reads.</p>
<p>L2 WFI files are calibrated rate images in instrumental units of DN / second.  They are two-dimensional arrays shaped as (4088 image rows, 4088 image columns). Note the smaller image size of L2 files, which is due to the removal of the 4-pixel border of reference pixels around the image during pipeline processing.</p>
<section id="local-run-settings">
<h3>Local Run Settings<a class="headerlink" href="#local-run-settings" title="Link to this heading">#</a></h3>
<p>If you want to run the notebook in your local machine, refer to the information in <a class="reference internal" href="../../markdown/local-run.html"><span class="std std-doc">local installation</span></a> instructions before proceeding with the notebook. The instructions provide inportant information about setting up your environment and installing dependnecies.</p>
</section>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<p>Libraries used:</p>
<ul class="simple">
<li><p><em>astropy</em> for coordinates manipulation and image normalization</p></li>
<li><p><em>copy</em> for making copies of Python objects</p></li>
<li><p><em>crds</em> for access to calibration reference files</p></li>
<li><p><em>matplotlib</em> and <em>mpl_toolkits</em> for plotting images</p></li>
<li><p><em>numpy</em> for array manipulation</p></li>
<li><p><em>romancal</em> for running the Roman WFI science data pipeline</p></li>
<li><p><em>roman_datamodels</em> for opening Roman WFI ASDF files</p></li>
<li><p><em>asdf</em> for opening Roman WFI ASDF files</p></li>
<li><p><em>os</em> for operating system functions</p></li>
<li><p><em>s3fs</em> for streaming files from an AWS S3 bucket</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span><span class="p">,</span> <span class="n">colormaps</span> <span class="k">as</span> <span class="n">cm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">roman_datamodels</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">s3fs</span>
</pre></div>
</div>
</div>
</div>
<section id="the-calibration-reference-data-system-crds">
<h3>The Calibration Reference Data System (CRDS)<a class="headerlink" href="#the-calibration-reference-data-system-crds" title="Link to this heading">#</a></h3>
<p>The Roman ELP, which corrects L1 images for detector-level effects to produce L2 images, uses calibration reference and parameter files from the <a class="reference external" href="https://roman-crds.stsci.edu/static/users_guide/overview.html">CRDS</a>. These reference files, developed and validated by STScI’s Science Operations Center, are continually updated as new WFI data become available. CRDS assigns the most appropriate reference file for each calibration step using metadata keywords and file-specific matching criteria. To use the best-available reference files for an observation, no action is needed as RomanCal will query for the best reference files for each calibration step in the pipeline.</p>
<p>In this tutorial, we will focus on the <strong><a class="reference external" href="https://roman-crds.stsci.edu/static/users_guide/index.html"><code class="docutils literal notranslate"><span class="pre">crds</span></code></a></strong> Python application programming interface (API). The <a class="reference external" href="https://roman-crds.stsci.edu"><strong>CRDS</strong> webserver</a> can also be accessed to browse calibration reference files in a tabular interface. Note that there are multiple CRDS servers, though most users will interact with the Operations (OPS) instance. Please be sure to navigate to the correct webserver for the instance in which you are interested.</p>
<p>For more details, see the <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/accessing-wfi-data/crds-for-reference-files">RDox page on CRDS for Roman WFI</a> and the <a class="reference external" href="https://jwst-crds.stsci.edu/static/users_guide/web_site_use.html">CRDS documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">crds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import romancal packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">romancal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">romancal.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExposurePipeline</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="tutorial-data">
<h2>Tutorial Data<a class="headerlink" href="#tutorial-data" title="Link to this heading">#</a></h2>
<p>In this tutorial, we use L1 WFI data files simulated with Roman I-Sim. As an example, we take the output product from the <a class="reference internal" href="../romanisim/romanisim.html"><span class="std std-doc">Roman I-Sim</span></a> tutorial notebook. If you have not run that simulation, the files are available in the Nexus S3 bucket. For more information on accessing these data, see the <a class="reference internal" href="../data_discovery_and_access/data_discovery_and_access.html"><span class="std std-doc">Data Discovery and Access</span></a> tutorial.</p>
</section>
<section id="running-the-elp-on-l1-data">
<h2>Running the ELP on L1 Data<a class="headerlink" href="#running-the-elp-on-l1-data" title="Link to this heading">#</a></h2>
<p>To run the ELP on L1 data, you have two options:</p>
<ol class="arabic simple">
<li><p><strong>Basic:</strong> Use <code class="docutils literal notranslate"><span class="pre">romancal.ExposurePipeline()</span></code> to run all steps.</p></li>
<li><p><strong>Advanced:</strong> Run one or more individual steps.</p></li>
</ol>
<section id="basic-example-full-pipeline">
<h3>Basic Example: Full Pipeline<a class="headerlink" href="#basic-example-full-pipeline" title="Link to this heading">#</a></h3>
<p>The input file for this example is a WFI L1 ASDF file. First, we check whether the file is already saved on disk (if the Roman I-Sim tutorial was run). If not, we stream the L1 file into memory (as a datamodel) from the Nexus S3 bucket:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l1_file</span> <span class="o">=</span> <span class="s1">&#39;r0003201001001001004_0001_wfi01_f106_uncal.asdf&#39;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">l1_file</span><span class="p">):</span>
    <span class="n">dm_l1</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l1_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">s3_uri</span> <span class="o">=</span> <span class="n">asdf_dir_uri</span> <span class="o">=</span> <span class="s1">&#39;s3://stpubdata/roman/nexus/soc_simulations/tutorial_data/&#39;</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dm_l1</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s3_uri</span> <span class="o">+</span> <span class="n">l1_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We begin by examining the data type using the <code class="docutils literal notranslate"><span class="pre">type()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">dm_l1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>roman_datamodels.datamodels._datamodels.ScienceRawModel
</pre></div>
</div>
</div>
</div>
<p>Reading the ASDF file with <code class="docutils literal notranslate"><span class="pre">roman_datamodels</span></code> returns a <code class="docutils literal notranslate"><span class="pre">ScienceRawModel</span></code> datamodel, which is the L1 file datamodel. At this point, we can use the <code class="docutils literal notranslate"><span class="pre">.info()</span></code> method on the data to look at the file contents:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_l1</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root (AsdfObject)
├─asdf_library (Software)
│ ├─author (str): The ASDF Developers
│ ├─homepage (str): http://github.com/asdf-format/asdf
│ ├─name (str): asdf
│ └─version (str): 4.1.0
├─history (AsdfDictNode)
│ └─extensions (AsdfListNode) ...
├─roman (WfiScienceRaw) # Level 1 (L1) Uncalibrated Roman Wide Field
Instrument (WFI) Ramp Cube

│ ├─meta (AsdfDictNode) ...
│ ├─data (NDArrayType) # Science Data (DN) ...
│ └─amp33 (NDArrayType) # Amplifier 33 Reference Pixel Data (DN) ...
└─romanisim (AsdfDictNode)
  ├─drop_extra_dq (bool): True
  ├─filename (str): r0003201001001001004_0001_wfi01_f106_uncal.asdf
  ├─level (int): 1
  ├─persistence (AsdfDictNode) ...
  ├─simcatobj (NDArrayType) ...
  ├─simulate_reffiles (AsdfDictNode) ...
  ├─stpsf (bool): True
  ├─usecrds (bool): True
  ├─version (str): 0.8.0
  └─wcs (WCS)
Some nodes not shown.
</pre></div>
</div>
</div>
</div>
<p>We can see that this L1 file was created with Roman I-Sim as it contains the “romanisim” block.</p>
<p>Next, we present a basic example of running the complete pipeline.</p>
<p>The optional <code class="docutils literal notranslate"><span class="pre">save_results</span></code> parameter determines whether the resulting L2 datamodel is saved as a file on your Nexus storage. Setting this parameter to <code class="docutils literal notranslate"><span class="pre">True</span></code> enables file saving. In this example, we retain the calibrated L2 datamodel in memory as the variable result without saving it locally.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">ExposurePipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dm_l1</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,970 - CRDS - ERROR -  Error determining best reference for &#39;pars-dqinitstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,971 - CRDS - ERROR -  Error determining best reference for &#39;pars-saturationstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,972 - CRDS - ERROR -  Error determining best reference for &#39;pars-refpixstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,973 - CRDS - ERROR -  Error determining best reference for &#39;pars-linearitystep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,974 - CRDS - ERROR -  Error determining best reference for &#39;pars-darkcurrentstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,975 - CRDS - ERROR -  Error determining best reference for &#39;pars-rampfitstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,976 - CRDS - ERROR -  Error determining best reference for &#39;pars-assignwcsstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,976 - CRDS - ERROR -  Error determining best reference for &#39;pars-flatfieldstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,977 - CRDS - ERROR -  Error determining best reference for &#39;pars-photomstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,978 - CRDS - ERROR -  Error determining best reference for &#39;pars-sourcecatalogstep&#39;  =   Unknown reference type &#39;pars-sourcecatalogstep&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,979 - CRDS - ERROR -  Error determining best reference for &#39;pars-tweakregstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,980 - CRDS - ERROR -  Error determining best reference for &#39;pars-exposurepipeline&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,987 - stpipe.ExposurePipeline - INFO - ExposurePipeline instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,988 - stpipe.ExposurePipeline.dq_init - INFO - DQInitStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,989 - stpipe.ExposurePipeline.saturation - INFO - SaturationStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,990 - stpipe.ExposurePipeline.refpix - INFO - RefPixStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,990 - stpipe.ExposurePipeline.linearity - INFO - LinearityStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,991 - stpipe.ExposurePipeline.dark_current - INFO - DarkCurrentStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,992 - stpipe.ExposurePipeline.rampfit - INFO - RampFitStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,993 - stpipe.ExposurePipeline.assign_wcs - INFO - AssignWcsStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,994 - stpipe.ExposurePipeline.flatfield - INFO - FlatFieldStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,995 - stpipe.ExposurePipeline.photom - INFO - PhotomStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,996 - stpipe.ExposurePipeline.source_catalog - INFO - SourceCatalogStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:36,998 - stpipe.ExposurePipeline.tweakreg - INFO - TweakRegStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,144 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline running with args (&lt;roman_datamodels.datamodels._datamodels.ScienceRawModel object at 0x7f01a96a67b0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,157 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline parameters are:
  pre_hooks: []
  post_hooks: []
  output_file: None
  output_dir: None
  output_ext: .asdf
  output_use_model: False
  output_use_index: True
  save_results: False
  skip: False
  suffix: cal
  search_output_file: True
  input_dir: &#39;&#39;
  save_l1_wcs: False
  steps:
    dq_init:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    saturation:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    refpix:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      remove_offset: True
      remove_trends: True
      cosine_interpolate: True
      fft_interpolate: True
    linearity:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    dark_current:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      dark_output: None
    rampfit:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: rampfit
      search_output_file: True
      input_dir: &#39;&#39;
      algorithm: ols_cas22
      save_opt: False
      use_ramp_jump_detection: True
      threshold_intercept: None
      threshold_constant: None
    assign_wcs:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    flatfield:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      include_var_flat: False
    photom:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    source_catalog:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: cat
      search_output_file: True
      input_dir: &#39;&#39;
      bkg_boxsize: 1000
      kernel_fwhm: 2.0
      snr_threshold: 3.0
      npixels: 25
      deblend: False
      fit_psf: True
      forced_segmentation: &#39;&#39;
    tweakreg:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: True
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      use_custom_catalogs: False
      catalog_format: ascii.ecsv
      catfile: &#39;&#39;
      catalog_path: &#39;&#39;
      enforce_user_order: False
      expand_refcat: False
      minobj: 15
      searchrad: 2.0
      use2dhist: True
      separation: 1.0
      tolerance: 0.7
      fitgeometry: rshift
      nclip: 3
      sigma: 3.0
      abs_refcat: GAIAREFCAT
      save_abs_catalog: False
      abs_minobj: 15
      abs_searchrad: 6.0
      abs_use2dhist: True
      abs_separation: 1.0
      abs_tolerance: 0.7
      abs_fitgeometry: rshift
      abs_nclip: 3
      abs_sigma: 3.0
      update_source_catalog_coordinates: False
      save_l1_wcs: True
      vo_timeout: 120.0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,158 - stpipe.ExposurePipeline - INFO - Prefetching reference files for dataset: &#39;r0003201001001001004_0001_wfi01_f106_uncal.asdf&#39; reftypes = [&#39;dark&#39;, &#39;distortion&#39;, &#39;flat&#39;, &#39;gain&#39;, &#39;linearity&#39;, &#39;mask&#39;, &#39;photom&#39;, &#39;readnoise&#39;, &#39;refpix&#39;, &#39;saturation&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,163 - stpipe.ExposurePipeline - INFO - Prefetch for DARK reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,164 - stpipe.ExposurePipeline - INFO - Prefetch for DISTORTION reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,164 - stpipe.ExposurePipeline - INFO - Prefetch for FLAT reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_flat_0175.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,165 - stpipe.ExposurePipeline - INFO - Prefetch for GAIN reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_gain_0022.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,166 - stpipe.ExposurePipeline - INFO - Prefetch for LINEARITY reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_linearity_0039.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,166 - stpipe.ExposurePipeline - INFO - Prefetch for MASK reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_mask_0030.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,167 - stpipe.ExposurePipeline - INFO - Prefetch for PHOTOM reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_photom_0040.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,167 - stpipe.ExposurePipeline - INFO - Prefetch for READNOISE reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_readnoise_0024.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,168 - stpipe.ExposurePipeline - INFO - Prefetch for REFPIX reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_refpix_0013.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,169 - stpipe.ExposurePipeline - INFO - Prefetch for SATURATION reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_saturation_0031.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,169 - romancal.pipeline.exposure_pipeline - INFO - Starting Roman exposure calibration pipeline ...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:37,319 - stpipe.ExposurePipeline.dq_init - INFO - Step dq_init running with args (&lt;roman_datamodels.datamodels._datamodels.ScienceRawModel object at 0x7f01a96a67b0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:39,886 - romancal.dq_init.dq_init_step - INFO - Flagging rows from: -999999 to -999999 as affected by guide window read
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:39,956 - stpipe.ExposurePipeline.dq_init - INFO - Step dq_init done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:40,108 - stpipe.ExposurePipeline.saturation - INFO - Step saturation running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a8f816a0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:40,111 - romancal.saturation.saturation_step - INFO - Using SATURATION reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_saturation_0031.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:41,193 - stcal.saturation.saturation - INFO - Detected 73498 saturated pixels
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:41,237 - stcal.saturation.saturation - INFO - Detected 66525 A/D floor pixels
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:41,258 - stpipe.ExposurePipeline.saturation - INFO - Step saturation done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:41,485 - stpipe.ExposurePipeline.refpix - INFO - Step refpix running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a8f816a0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages/romancal/refpix/data.py:398: RuntimeWarning: invalid value encountered in divide
  kern = (cov / mask_conv).reshape(rows, columns)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:44,108 - stpipe.ExposurePipeline.refpix - INFO - Step refpix done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:44,271 - stpipe.ExposurePipeline.linearity - INFO - Step linearity running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a8f816a0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:44,274 - romancal.linearity.linearity_step - INFO - Using LINEARITY reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_linearity_0039.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:45,712 - stpipe.ExposurePipeline.linearity - INFO - Step linearity done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:45,869 - stpipe.ExposurePipeline.rampfit - INFO - Step rampfit running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a8f816a0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:45,874 - romancal.ramp_fitting.ramp_fit_step - INFO - Using READNOISE reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_readnoise_0024.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:45,889 - romancal.ramp_fitting.ramp_fit_step - INFO - Using GAIN reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_gain_0022.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:45,903 - romancal.ramp_fitting.ramp_fit_step - INFO - Jump detection as part of ramp fitting is enabled.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:52,854 - stpipe.ExposurePipeline.rampfit - INFO - Step rampfit done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,015 - stpipe.ExposurePipeline.dark_current - INFO - Step dark_current running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a8f81d30&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,018 - romancal.dark_current.dark_current_step - INFO - Using DARK reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,732 - stpipe.ExposurePipeline.dark_current - INFO - Step dark_current done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,888 - stpipe.ExposurePipeline.assign_wcs - INFO - Step assign_wcs running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a8f81d30&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,889 - romancal.assign_wcs.assign_wcs_step - INFO - reftype, distortion
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,891 - romancal.assign_wcs.assign_wcs_step - INFO - Using reference files: {&#39;distortion&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;} for assign_wcs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,944 - stcal.alignment.util - INFO - Update S_REGION to POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,944 - romancal.assign_wcs.utils - INFO - S_REGION VALUES: POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,944 - romancal.assign_wcs.utils - INFO - Update S_REGION to POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:53,946 - stpipe.ExposurePipeline.assign_wcs - INFO - Step assign_wcs done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,100 - stpipe.ExposurePipeline.flatfield - INFO - Step flatfield running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a8f81d30&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,373 - stpipe.ExposurePipeline.flatfield - INFO - Step flatfield done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,526 - stpipe.ExposurePipeline.photom - INFO - Step photom running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a8f81d30&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,543 - romancal.photom.photom - INFO - photmjsr value: 0.741749
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,544 - romancal.photom.photom - INFO - uncertainty value: 0.0288573
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,545 - stpipe.ExposurePipeline.photom - INFO - Step photom done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,700 - stpipe.ExposurePipeline.source_catalog - INFO - Step source_catalog running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a8f81d30&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,703 - romancal.source_catalog.source_catalog_step - INFO - Using ePSF reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_epsf_0112.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:54,820 - romancal.source_catalog.source_catalog_step - INFO - Calculating and subtracting background
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:57,870 - romancal.source_catalog.source_catalog_step - INFO - Creating detection image
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:35:58,995 - romancal.source_catalog.source_catalog_step - INFO - Detecting sources
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:01,223 - romancal.source_catalog.detection - INFO - Detected 1458 sources
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:01,224 - romancal.source_catalog.source_catalog_step - INFO - Creating source catalog
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:01,264 - romancal.source_catalog.source_catalog - INFO - Calculating segment properties
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:08,404 - romancal.source_catalog.source_catalog - INFO - Calculating aperture photometry
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:09,820 - romancal.source_catalog.source_catalog - INFO - Calculating DAOFind properties
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:10,062 - romancal.source_catalog.source_catalog - INFO - Calculating nearest neighbor properties
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:10,065 - romancal.source_catalog.source_catalog - INFO - Calculating PSF photometry
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: One or more fit(s) may not have converged. Please check the &quot;flags&quot; column in the output table. [photutils.psf._components]
2025-12-11 19:36:28,885 - astropy - WARNING - One or more fit(s) may not have converged. Please check the &quot;flags&quot; column in the output table.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:29,220 - stpipe.ExposurePipeline.source_catalog - INFO - Saved model in r0003201001001001004_0001_wfi01_f106_segm.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:29,817 - stpipe.ExposurePipeline.source_catalog - INFO - Saved model in r0003201001001001004_0001_wfi01_f106_cat.parquet
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:29,942 - stpipe.ExposurePipeline.source_catalog - INFO - Step source_catalog done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:30,121 - stpipe.ExposurePipeline.tweakreg - INFO - Step tweakreg running with args (&lt;romancal.datamodels.library.ModelLibrary object at 0x7f01a8f80ad0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:30,122 - romancal.tweakreg.tweakreg_step - INFO - Number of image groups to be aligned: 1.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:30,123 - romancal.tweakreg.tweakreg_step - INFO - Image groups:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:30,123 - romancal.tweakreg.tweakreg_step - INFO -   00032010010010010040001
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:30,124 - romancal.tweakreg.tweakreg_step - INFO - All source catalogs will be saved to: /home/runner/work/roman_notebooks/roman_notebooks/notebooks/exposure_pipeline
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:30,165 - romancal.tweakreg.tweakreg_step - INFO - Detected 1458 sources in r0003201001001001004_0001_wfi01_f106_uncal.asdf.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,492 - tweakwcs.imalign - INFO -  
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,492 - tweakwcs.imalign - INFO - ***** tweakwcs.imalign.align_wcs() started on 2025-12-11 19:36:31.492038
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,493 - tweakwcs.imalign - INFO -       Version 0.8.12
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,493 - tweakwcs.imalign - INFO -  
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,645 - tweakwcs.imalign - INFO - Aligning image catalog &#39;GROUP ID: 987654&#39; to the reference catalog.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,683 - tweakwcs.matchutils - INFO - Matching sources from &#39;r0003201001001001004_0001_wfi01_f106_uncal&#39; catalog with sources from the reference &#39;GAIAREFCAT&#39; catalog.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,684 - tweakwcs.matchutils - INFO - Computing initial guess for X and Y shifts...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,689 - tweakwcs.matchutils - INFO - Found initial X and Y shifts of 0.01183, 0.01183 (arcsec) with significance of 1332 and 1398 matches.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,691 - tweakwcs.wcsimage - INFO - Found 1397 matches for &#39;GROUP ID: 987654&#39;...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,692 - tweakwcs.linearfit - INFO - Performing &#39;rshift&#39; fit
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,697 - tweakwcs.wcsimage - INFO - Computed &#39;rshift&#39; fit for GROUP ID: 987654:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,697 - tweakwcs.wcsimage - INFO - XSH: -0.000630618  YSH: 0.00029481    ROT: -3.33116e-06    SCALE: 1
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,697 - tweakwcs.wcsimage - INFO - 
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,698 - tweakwcs.wcsimage - INFO - FIT RMSE: 0.0025151   FIT MAE: 0.00218818
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,698 - tweakwcs.wcsimage - INFO - Final solution based on 1385 objects.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,728 - tweakwcs.imalign - INFO -  
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,728 - tweakwcs.imalign - INFO - ***** tweakwcs.imalign.align_wcs() ended on 2025-12-11 19:36:31.728350
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,729 - tweakwcs.imalign - INFO - ***** tweakwcs.imalign.align_wcs() TOTAL RUN TIME: 0:00:00.236312
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,729 - tweakwcs.imalign - INFO -  
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,733 - stcal.alignment.util - INFO - Update S_REGION to POLYGON ICRS  270.934684858 -0.225734332 270.934627079 -0.102770863 270.809037017 -0.102466397 270.809759321 -0.225325256
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,734 - romancal.assign_wcs.utils - INFO - S_REGION VALUES: POLYGON ICRS  270.934684858 -0.225734332 270.934627079 -0.102770863 270.809037017 -0.102466397 270.809759321 -0.225325256
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,734 - romancal.assign_wcs.utils - INFO - Update S_REGION to POLYGON ICRS  270.934684858 -0.225734332 270.934627079 -0.102770863 270.809037017 -0.102466397 270.809759321 -0.225325256
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,735 - romancal.lib.save_wcs - INFO - Writing the WCS files...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,858 - stpipe.ExposurePipeline.tweakreg - INFO - Saved model in r0003201001001001004_0001_wfi01_f106_wcs.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,860 - stpipe.ExposurePipeline.tweakreg - INFO - Step tweakreg done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,861 - romancal.pipeline.exposure_pipeline - INFO - Roman exposure calibration pipeline ending...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,862 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline done
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>roman_datamodels.datamodels._datamodels.ImageModel
</pre></div>
</div>
</div>
</div>
<p>The output from the Exposure Pipeline is an <code class="docutils literal notranslate"><span class="pre">ImageModel</span></code> object, which serves as the datamodel for L2 files.</p>
<p>In addition, the pipeline created three other files in the working directory with names similar to the input L1 file. These files end with <code class="docutils literal notranslate"><span class="pre">*_cat.parquet</span></code>, <code class="docutils literal notranslate"><span class="pre">*_segm.asdf</span></code>, and <code class="docutils literal notranslate"><span class="pre">*_wcs.asdf</span></code>, corresponding to a Level 4 (L4) single-band source catalog, a L4 segmentation map, and a L1 updated WCS file, respectively. The L1 WCS file provides a L2-quality World Coordinate System (WCS) when working with a L1 file, which have a different number of pixels than L2 files, without updating the original L1 file on disk. More information about working with L4 products will be added in another future tutorial. <strong>Note:</strong> L4 products are still being validated and should be used with caution during development.</p>
<p>Optional parameters can also be passed to individual pipeline steps through the steps dictionary. For example, the code below demonstrates how to skip both the source catalog step and the step that aligns the image with the Gaia astrometric catalog (the TweakReg step, named after the software used to update the WCS). Other parameters can be configured in the same way; for details, see the <a class="reference external" href="https://roman-pipeline.readthedocs.io/en/latest/index.html">romancal documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">ExposurePipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dm_l1</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;source_catalog&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;skip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="s1">&#39;tweakreg&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;skip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,875 - CRDS - ERROR -  Error determining best reference for &#39;pars-dqinitstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,876 - CRDS - ERROR -  Error determining best reference for &#39;pars-saturationstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,877 - CRDS - ERROR -  Error determining best reference for &#39;pars-refpixstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,877 - CRDS - ERROR -  Error determining best reference for &#39;pars-linearitystep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,878 - CRDS - ERROR -  Error determining best reference for &#39;pars-darkcurrentstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,880 - CRDS - ERROR -  Error determining best reference for &#39;pars-rampfitstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,881 - CRDS - ERROR -  Error determining best reference for &#39;pars-assignwcsstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,882 - CRDS - ERROR -  Error determining best reference for &#39;pars-flatfieldstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,883 - CRDS - ERROR -  Error determining best reference for &#39;pars-photomstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,884 - CRDS - ERROR -  Error determining best reference for &#39;pars-sourcecatalogstep&#39;  =   Unknown reference type &#39;pars-sourcecatalogstep&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,885 - CRDS - ERROR -  Error determining best reference for &#39;pars-tweakregstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,886 - CRDS - ERROR -  Error determining best reference for &#39;pars-exposurepipeline&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,891 - stpipe.ExposurePipeline - INFO - ExposurePipeline instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,892 - stpipe.ExposurePipeline.dq_init - INFO - DQInitStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,894 - stpipe.ExposurePipeline.saturation - INFO - SaturationStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,895 - stpipe.ExposurePipeline.refpix - INFO - RefPixStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,895 - stpipe.ExposurePipeline.linearity - INFO - LinearityStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,896 - stpipe.ExposurePipeline.dark_current - INFO - DarkCurrentStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,897 - stpipe.ExposurePipeline.rampfit - INFO - RampFitStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,899 - stpipe.ExposurePipeline.assign_wcs - INFO - AssignWcsStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,899 - stpipe.ExposurePipeline.flatfield - INFO - FlatFieldStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,900 - stpipe.ExposurePipeline.photom - INFO - PhotomStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,901 - stpipe.ExposurePipeline.source_catalog - INFO - SourceCatalogStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:31,903 - stpipe.ExposurePipeline.tweakreg - INFO - TweakRegStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,087 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline running with args (&lt;roman_datamodels.datamodels._datamodels.ScienceRawModel object at 0x7f01a96a67b0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,099 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline parameters are:
  pre_hooks: []
  post_hooks: []
  output_file: None
  output_dir: None
  output_ext: .asdf
  output_use_model: False
  output_use_index: True
  save_results: False
  skip: False
  suffix: cal
  search_output_file: True
  input_dir: &#39;&#39;
  save_l1_wcs: False
  steps:
    dq_init:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    saturation:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    refpix:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      remove_offset: True
      remove_trends: True
      cosine_interpolate: True
      fft_interpolate: True
    linearity:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    dark_current:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      dark_output: None
    rampfit:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: rampfit
      search_output_file: True
      input_dir: &#39;&#39;
      algorithm: ols_cas22
      save_opt: False
      use_ramp_jump_detection: True
      threshold_intercept: None
      threshold_constant: None
    assign_wcs:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    flatfield:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      include_var_flat: False
    photom:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    source_catalog:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: True
      suffix: cat
      search_output_file: True
      input_dir: &#39;&#39;
      bkg_boxsize: 1000
      kernel_fwhm: 2.0
      snr_threshold: 3.0
      npixels: 25
      deblend: False
      fit_psf: True
      forced_segmentation: &#39;&#39;
    tweakreg:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: True
      output_use_index: True
      save_results: False
      skip: True
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      use_custom_catalogs: False
      catalog_format: ascii.ecsv
      catfile: &#39;&#39;
      catalog_path: &#39;&#39;
      enforce_user_order: False
      expand_refcat: False
      minobj: 15
      searchrad: 2.0
      use2dhist: True
      separation: 1.0
      tolerance: 0.7
      fitgeometry: rshift
      nclip: 3
      sigma: 3.0
      abs_refcat: GAIAREFCAT
      save_abs_catalog: False
      abs_minobj: 15
      abs_searchrad: 6.0
      abs_use2dhist: True
      abs_separation: 1.0
      abs_tolerance: 0.7
      abs_fitgeometry: rshift
      abs_nclip: 3
      abs_sigma: 3.0
      update_source_catalog_coordinates: False
      save_l1_wcs: True
      vo_timeout: 120.0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,101 - stpipe.ExposurePipeline - INFO - Prefetching reference files for dataset: &#39;r0003201001001001004_0001_wfi01_f106_uncal.asdf&#39; reftypes = [&#39;dark&#39;, &#39;distortion&#39;, &#39;flat&#39;, &#39;gain&#39;, &#39;linearity&#39;, &#39;mask&#39;, &#39;photom&#39;, &#39;readnoise&#39;, &#39;refpix&#39;, &#39;saturation&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,103 - stpipe.ExposurePipeline - INFO - Prefetch for DARK reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,104 - stpipe.ExposurePipeline - INFO - Prefetch for DISTORTION reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,104 - stpipe.ExposurePipeline - INFO - Prefetch for FLAT reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_flat_0175.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,105 - stpipe.ExposurePipeline - INFO - Prefetch for GAIN reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_gain_0022.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,105 - stpipe.ExposurePipeline - INFO - Prefetch for LINEARITY reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_linearity_0039.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,106 - stpipe.ExposurePipeline - INFO - Prefetch for MASK reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_mask_0030.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,107 - stpipe.ExposurePipeline - INFO - Prefetch for PHOTOM reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_photom_0040.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,107 - stpipe.ExposurePipeline - INFO - Prefetch for READNOISE reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_readnoise_0024.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,108 - stpipe.ExposurePipeline - INFO - Prefetch for REFPIX reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_refpix_0013.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,108 - stpipe.ExposurePipeline - INFO - Prefetch for SATURATION reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_saturation_0031.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,109 - romancal.pipeline.exposure_pipeline - INFO - Starting Roman exposure calibration pipeline ...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,287 - stpipe.ExposurePipeline.dq_init - INFO - Step dq_init running with args (&lt;roman_datamodels.datamodels._datamodels.ScienceRawModel object at 0x7f01a96a67b0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,367 - romancal.dq_init.dq_init_step - INFO - Flagging rows from: -999999 to -999999 as affected by guide window read
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,432 - stpipe.ExposurePipeline.dq_init - INFO - Step dq_init done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,611 - stpipe.ExposurePipeline.saturation - INFO - Step saturation running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f0192094a50&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:32,614 - romancal.saturation.saturation_step - INFO - Using SATURATION reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_saturation_0031.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:33,683 - stcal.saturation.saturation - INFO - Detected 73498 saturated pixels
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:33,728 - stcal.saturation.saturation - INFO - Detected 66525 A/D floor pixels
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:33,749 - stpipe.ExposurePipeline.saturation - INFO - Step saturation done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:33,997 - stpipe.ExposurePipeline.refpix - INFO - Step refpix running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f0192094a50&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages/romancal/refpix/data.py:398: RuntimeWarning: invalid value encountered in divide
  kern = (cov / mask_conv).reshape(rows, columns)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:36,602 - stpipe.ExposurePipeline.refpix - INFO - Step refpix done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:36,775 - stpipe.ExposurePipeline.linearity - INFO - Step linearity running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f0192094a50&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:36,777 - romancal.linearity.linearity_step - INFO - Using LINEARITY reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_linearity_0039.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:38,210 - stpipe.ExposurePipeline.linearity - INFO - Step linearity done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:38,382 - stpipe.ExposurePipeline.rampfit - INFO - Step rampfit running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f0192094a50&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:38,386 - romancal.ramp_fitting.ramp_fit_step - INFO - Using READNOISE reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_readnoise_0024.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:38,400 - romancal.ramp_fitting.ramp_fit_step - INFO - Using GAIN reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_gain_0022.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:38,414 - romancal.ramp_fitting.ramp_fit_step - INFO - Jump detection as part of ramp fitting is enabled.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:45,354 - stpipe.ExposurePipeline.rampfit - INFO - Step rampfit done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:45,534 - stpipe.ExposurePipeline.dark_current - INFO - Step dark_current running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f0192096fd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:45,537 - romancal.dark_current.dark_current_step - INFO - Using DARK reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,244 - stpipe.ExposurePipeline.dark_current - INFO - Step dark_current done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,423 - stpipe.ExposurePipeline.assign_wcs - INFO - Step assign_wcs running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f0192096fd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,424 - romancal.assign_wcs.assign_wcs_step - INFO - reftype, distortion
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,426 - romancal.assign_wcs.assign_wcs_step - INFO - Using reference files: {&#39;distortion&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;} for assign_wcs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,477 - stcal.alignment.util - INFO - Update S_REGION to POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,478 - romancal.assign_wcs.utils - INFO - S_REGION VALUES: POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,478 - romancal.assign_wcs.utils - INFO - Update S_REGION to POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,480 - stpipe.ExposurePipeline.assign_wcs - INFO - Step assign_wcs done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,664 - stpipe.ExposurePipeline.flatfield - INFO - Step flatfield running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f0192096fd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:46,937 - stpipe.ExposurePipeline.flatfield - INFO - Step flatfield done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,109 - stpipe.ExposurePipeline.photom - INFO - Step photom running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f0192096fd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,126 - romancal.photom.photom - INFO - photmjsr value: 0.741749
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,126 - romancal.photom.photom - INFO - uncertainty value: 0.0288573
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,128 - stpipe.ExposurePipeline.photom - INFO - Step photom done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,300 - stpipe.ExposurePipeline.source_catalog - INFO - Step source_catalog running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f0192096fd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,301 - stpipe.ExposurePipeline.source_catalog - INFO - Step skipped.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,478 - stpipe.ExposurePipeline.tweakreg - INFO - Step tweakreg running with args (&lt;romancal.datamodels.library.ModelLibrary object at 0x7f01920956d0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,478 - stpipe.ExposurePipeline.tweakreg - INFO - Step skipped.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,480 - romancal.pipeline.exposure_pipeline - INFO - Roman exposure calibration pipeline ending...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:47,481 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline done
</pre></div>
</div>
</div>
</div>
<p>At the end of the pipeline log messages, you will see that the SourceCatalog and TweakReg steps were skipped, as expected. Because the source catalog step was omitted, the L4 source catalog and segmentation map files were not regenerated. To verify the status of a step, you can also inspect the metadata of the output datamodel:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">cal_step</span><span class="o">.</span><span class="n">source_catalog</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SKIPPED&#39;
</pre></div>
</div>
</div>
</div>
<p>More information on these steps can be found in the <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/roman-data-pipelines/exposure-level-pipeline#ExposureLevelPipeline-PipelineStepDescriptions">Exposure Pipeline</a> article on RDox.</p>
<p>Note that the ramp-fitting step transforms the structure of the data — in other words, the data models before and after ramp fitting are intrinsically different. Therefore, steps following ramp fitting cannot be applied to data that has not undergone it, and similarly, steps preceding ramp fitting cannot be applied once the data has.</p>
<p>We can save our L2 datamodel to disk with the <code class="docutils literal notranslate"><span class="pre">.save()</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;my_roman_l2_file.asdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PosixPath(&#39;my_roman_l2_file.asdf&#39;)
</pre></div>
</div>
</div>
</div>
<p>If you look at the file browser in the directory where you ran this tutorial, you should see a new file called “my_roman_l2_file.asdf”. Note that you may need to wait a moment or manually refresh the file browser before it appears.</p>
</section>
<section id="advanced-example-running-individual-pipeline-steps">
<h3>Advanced Example: Running Individual Pipeline Steps<a class="headerlink" href="#advanced-example-running-individual-pipeline-steps" title="Link to this heading">#</a></h3>
<p>Now, for a more advanced use case, let’s update the WCS based on the pointing information. For example, suppose we simulated an L1 file, processed it with the ELP, and now want to try shifting the pointing information and creating a new WCS to test the Gaia alignment. After editing any of the <code class="docutils literal notranslate"><span class="pre">meta.wcsinfo</span></code> values we wish to change, we can generate a new WCS by running the AssignWcsStep on our L2 ASDF file.</p>
<p>Let’s start by reading in a fresh L2 file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2_file</span> <span class="o">=</span> <span class="s1">&#39;r0003201001001001004_0001_wfi01_f106_cal.asdf&#39;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">l2_file</span><span class="p">):</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l2_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">s3_uri</span> <span class="o">=</span> <span class="n">asdf_dir_uri</span> <span class="o">=</span> <span class="s1">&#39;s3://stpubdata/roman/nexus/soc_simulations/tutorial_data/&#39;</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s3_uri</span> <span class="o">+</span> <span class="n">l2_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">original_wcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a quick look at the file we just opened:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root (AsdfObject)
├─asdf_library (Software)
│ ├─author (str): The ASDF Developers
│ ├─homepage (str): http://github.com/asdf-format/asdf
│ ├─name (str): asdf
│ └─version (str): 4.1.0
├─history (AsdfDictNode)
│ └─extensions (AsdfListNode) ...
└─roman (WfiImage) # Level 2 (L2) Calibrated Roman Wide Field Instrument (WFI) Rate Image.
  ├─meta (AsdfDictNode) ...
  ├─data (NDArrayType) # Science Data (DN/s) or (MJy/sr) ...
  ├─dq (NDArrayType) # Data Quality ...
  ├─err (NDArrayType) # Error (DN / s) or (MJy / sr) ...
  ├─var_poisson (NDArrayType) # Poisson Variance (DN^2/s^2) or (MJy^2/sr^2) ...
  ├─var_rnoise (NDArrayType) # Read Noise Variance (DN^2/s^2) or (MJy^2/sr^2) ...
  ├─var_flat (NDArrayType) # Flat Field Variance (DN^2/s^2) or (MJy^2/sr^2) ...
  ├─amp33 (NDArrayType) # Amplifier 33 Reference Pixel Data (DN) ...
  ├─border_ref_pix_left (NDArrayType) # Left-Edge Border Reference Pixels (DN) ...
  ├─border_ref_pix_right (NDArrayType) # Right-Edge Border Reference Pixels (DN) ...
  ├─border_ref_pix_top (NDArrayType) # Border Reference Pixels on the Top of the Detector (DN) ...
  ├─border_ref_pix_bottom (NDArrayType) # Bottom-Edge Border Reference Pixels (DN) ...
  ├─dq_border_ref_pix_left (NDArrayType) # Left-Edge Border Reference Pixel Data Quality (DN) ...
  └─3 not shown
Some nodes not shown.
</pre></div>
</div>
</div>
</div>
<p>Before aligning the images with the Gaia coordinates, the WCS in an L2 file is populated using the telescope pointing information, resulting in the so-called “coarse WCS”. The <code class="docutils literal notranslate"><span class="pre">meta.pointing</span></code> section of the metadata describes the spacecraft pointing, while the detector-dependent information used to construct the coarse WCS is contained in the <code class="docutils literal notranslate"><span class="pre">meta.wcsinfo</span></code> section. Although the values in <code class="docutils literal notranslate"><span class="pre">meta.pointing</span></code> and <code class="docutils literal notranslate"><span class="pre">meta.wcsinfo</span></code> are linked, the coarse WCS relies only on <code class="docutils literal notranslate"><span class="pre">meta.wcsinfo</span></code>. Let’s examine our <code class="docutils literal notranslate"><span class="pre">meta.wcsinfo</span></code> values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;aperture_name&#39;: &#39;WFI01_FULL&#39;, &#39;pa_aperture&#39;: 0.0, &#39;v2_ref&#39;: 1312.9491452484797, &#39;v3_ref&#39;: -1040.7853726755036, &#39;vparity&#39;: -1, &#39;v3yangle&#39;: -60.0, &#39;ra_ref&#39;: 270.8719766359773, &#39;dec_ref&#39;: -0.16439949970729792, &#39;roll_ref&#39;: 59.99991238605934, &#39;s_region&#39;: &#39;POLYGON ICRS  270.934669679 -0.225719501 270.934611821 -0.102755795 270.809021726 -0.102451279 270.809744086 -0.225310345&#39;}
</pre></div>
</div>
</div>
</div>
<p>Let’s focus on the <code class="docutils literal notranslate"><span class="pre">ra_ref</span></code>, <code class="docutils literal notranslate"><span class="pre">dec_ref</span></code>, and <code class="docutils literal notranslate"><span class="pre">roll_ref</span></code> keywords. Let’s first take a look at the descriptions of these fields:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ra_ref = </span><span class="si">{</span><span class="n">dm</span><span class="o">.</span><span class="n">schema_info</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;roman.meta.wcsinfo.ra_ref&#39;</span><span class="p">)[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dec_ref = </span><span class="si">{</span><span class="n">dm</span><span class="o">.</span><span class="n">schema_info</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;roman.meta.wcsinfo.dec_ref&#39;</span><span class="p">)[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;roll_ref = </span><span class="si">{</span><span class="n">dm</span><span class="o">.</span><span class="n">schema_info</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;roman.meta.wcsinfo.roll_ref&#39;</span><span class="p">)[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ra_ref = Right ascension of the reference pixel position on the
sky in units of degrees.

dec_ref = Declination of the reference pixel position on the sky
in units of degrees.

roll_ref = Position angle of the telescope V3 axis at the
reference pixel position measured from North to East. The
telescope V coordinate system is defined with its origin at the
vertex of the primary mirror. The +V3 axis is orthogonal to the
sunshield. See Roman-STScI-000143 &quot;Description of the Roman SIAF
and Coordinate Frames&quot; for more information.
</pre></div>
</div>
</div>
</div>
<p>The “reference pixel position” mentioned in these descriptions is located at the center of each WFI detector (each detector has its own WCS). We can edit these values to make the pipeline create a WCS solution that is slightly different from the original. Let’s make a copy of the data (for comparison later) and apply a simple shift of 1 arcsecond in right ascension:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">original_ra_ref</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">ra_ref</span><span class="p">)</span>
<span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">ra_ref</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original ra_ref = </span><span class="si">{</span><span class="n">original_ra_ref</span><span class="si">}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">Updated ra_ref = </span><span class="si">{</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">ra_ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original ra_ref = 270.8719766359773,
Updated ra_ref = 270.8722544137551
</pre></div>
</div>
</div>
</div>
<p>Next, let’s run AssignWcsStep on the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">romancal</span><span class="o">.</span><span class="n">assign_wcs</span><span class="o">.</span><span class="n">AssignWcsStep</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,161 - CRDS - ERROR -  Error determining best reference for &#39;pars-assignwcsstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,162 - stpipe.AssignWcsStep - INFO - AssignWcsStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,348 - stpipe.AssignWcsStep - INFO - Step AssignWcsStep running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f017695d6e0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,350 - stpipe.AssignWcsStep - INFO - Step AssignWcsStep parameters are:
  pre_hooks: []
  post_hooks: []
  output_file: None
  output_dir: None
  output_ext: .asdf
  output_use_model: False
  output_use_index: True
  save_results: False
  skip: False
  suffix: None
  search_output_file: True
  input_dir: &#39;&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,350 - romancal.assign_wcs.assign_wcs_step - INFO - reftype, distortion
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,358 - romancal.assign_wcs.assign_wcs_step - INFO - Using reference files: {&#39;distortion&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;} for assign_wcs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,409 - stcal.alignment.util - INFO - Update S_REGION to POLYGON ICRS  270.934962807 -0.225734417 270.934905036 -0.102770948 270.809314973 -0.102466475 270.810037271 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,409 - romancal.assign_wcs.utils - INFO - S_REGION VALUES: POLYGON ICRS  270.934962807 -0.225734417 270.934905036 -0.102770948 270.809314973 -0.102466475 270.810037271 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,410 - romancal.assign_wcs.utils - INFO - Update S_REGION to POLYGON ICRS  270.934962807 -0.225734417 270.934905036 -0.102770948 270.809314973 -0.102466475 270.810037271 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,411 - romancal.stpipe.core - INFO - Results used CRDS context: roman_0041.pmap
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:36:51,412 - stpipe.AssignWcsStep - INFO - Step AssignWcsStep done
</pre></div>
</div>
</div>
</div>
<p>Let’s now verify whether the coordinate system has changed as expected by comparing the right ascension and declination of a given pixel in the two WCS reference systems. For simplicity, we’ll use the center of the L2 image, which corresponds to (x, y) = (2043.5, 2043.5) in 0-indexed pixels. The corresponding sky coordinates can be easily obtained using <code class="docutils literal notranslate"><span class="pre">astropy.coordinates.SkyCoord</span></code> objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get SkyCoord object for new position at center of detector</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="mf">2043.5</span><span class="p">,</span> <span class="mf">2043.5</span><span class="p">)</span>
<span class="n">result_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
<span class="n">result_coord</span>

<span class="c1"># Get SkyCoord object for original position at center of detector</span>
<span class="n">ra0</span><span class="p">,</span> <span class="n">dec0</span> <span class="o">=</span> <span class="n">original_wcs</span><span class="p">(</span><span class="mf">2043.5</span><span class="p">,</span> <span class="mf">2043.5</span><span class="p">)</span>
<span class="n">original_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra0</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
<span class="n">original_coord</span>

<span class="c1"># Compute the separation between the updated and original positions</span>
<span class="n">result_coord</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">original_coord</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[0^\circ00{}^\prime01.00019156{}^{\prime\prime}\]</div>
</div>
</div>
<p>As we can see, the newly updated WCS is shifted by approximately 1 arcsecond relative to the WCS in the original L2 file. The offset is not exactly 1 arcsecond because the WFI pixel grid is slightly rotated with respect to the celestial coordinate system. In other words, the detector axes are not perfectly aligned with the vertical (declination) and horizontal (right ascension) directions on the sky.</p>
<p>As in our pipeline example above, we can also pass optional arguments to individual steps. This is useful if we want to use our own version, or an older version, of a reference file.</p>
</section>
</section>
<section id="reference-files">
<h2>Reference Files<a class="headerlink" href="#reference-files" title="Link to this heading">#</a></h2>
<p>As mentioned above, several of the pipeline steps apply reference files to the data to correct for specific detectors’ effects.
Common examples of reference files applied during the processing of imaging data include the <strong>Bad Pixel Mask</strong>, <strong>Dark</strong>, and <strong>Flat</strong> (see below details on each). More information on WFI reference file types can be found in the RDox article <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/accessing-wfi-data/crds-for-reference-files">CRDS for Reference Files</a>.</p>
<p><strong>IMPORTANT NOTE:</strong> Reference files are a work in progress and will be updated several times before Roman launch. If you notice irregularities or missing information, please understand that they may be a known issue. If you have questions, please contact the <a class="reference external" href="https://romanhelp.stsci.edu">Roman Help Desk</a>.</p>
<section id="bad-pixel-masks">
<h3>Bad Pixel Masks<a class="headerlink" href="#bad-pixel-masks" title="Link to this heading">#</a></h3>
<p>Bad pixels are masked during the Data Quality (DQ) initialization step.  The MASK reference file, which contains static bad pixel flags (i.e., locations of dead pixels, telegraph pixels, etc.) for each detector, populates the data quality (DQ) <code class="docutils literal notranslate"><span class="pre">dq</span></code> array of the L2 calibrated rate image files after processing by RomanCal. During RomanCal processing, the MASK file is used in the <code class="docutils literal notranslate"><span class="pre">romancal.dq_init.DQInitStep()</span></code> step (the first step in the ELP) to populate an array called <code class="docutils literal notranslate"><span class="pre">pixeldq</span></code> in the RampModel datamodel, which is used within the pipeline. DQ flags are combined with additional DQ flags from reference file DQ arrays during subsequent processing steps using <code class="docutils literal notranslate"><span class="pre">bitwise_or</span></code>.</p>
<p>These mask reference files are created from dark or flat calibration datasets. Different types of pixels are flagged based on their pixel values (i.e., dead pixels with significantly reduced detector response) or behavior up-the-ramp (i.e., telegraph pixels jump between two electronic states).</p>
<p>For more details, see the <a class="reference external" href="https://roman-pipeline.readthedocs.io/en/latest/roman/dq_init/index.html">romancal documentation</a> and <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/roman-data-pipelines/exposure-level-pipeline#ExposureLevelPipeline-dq_init">Rdox documentation</a> for DQ initialization.</p>
</section>
<section id="darks">
<h3>Darks<a class="headerlink" href="#darks" title="Link to this heading">#</a></h3>
<p>The DARK reference file is selected based on the WFI mode (imaging or spectroscopy) used to obtain the science data. During the <code class="docutils literal notranslate"><span class="pre">romancal.dark_current.DarkCurrentStep()</span></code> step, the dark current is subtracted off on a pixel-by-pixel and resultant-by-resultant basis. Pixels that are undefined in the dark reference file will not be subtracted from the science data.</p>
<p>The dark reference files are created from dark calibration datasets.  A set of dark files are sigma clipped, and stacked resultant-by-resultant to create a super dark.</p>
<p>For more details, see the <a class="reference external" href="https://roman-pipeline.readthedocs.io/en/latest/roman/dark_current/index.html">romancal documentation</a> and <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/roman-data-pipelines/exposure-level-pipeline#ExposureLevelPipeline-dark_current">Rdox documentation</a> for dark current subtraction.</p>
</section>
<section id="flats">
<h3>Flats<a class="headerlink" href="#flats" title="Link to this heading">#</a></h3>
<p>The FLAT reference file is selected based on the optical element used to obtain the science data.  It contains the flatfield data which corrects for both large-scale and pixel-to-pixel sensitivity variations, ensuring uniform data for a specific imaging filter.  During the <code class="docutils literal notranslate"><span class="pre">romancal.flatfield.FlatFieldStep()</span></code> step, the science array is divided by the flatfield reference array for the matching filter, effectively “flattening” the variations in the data.  Pixels with negative values or that are flagged will be skipped and not updated.</p>
<p>The flat reference file is created from flat calibration datasets.  A set of flat exposures with the same filter within some date range to the science data are used to compute flat rate images. These are averaged together and normalized, producing a filter-dependent flat rate image. Spectroscopic mode observations are not flatfielded by RomanCal, and there are no flat reference files available for the WFI grism or prism available from the Science Operations Center at STScI. For grism and prism observations, the flatfield step will be skipped.</p>
<p>For more details, see the <a class="reference external" href="https://roman-pipeline.readthedocs.io/en/latest/roman/flatfield/index.html">romancal documentation</a> and <a class="reference external" href="https://roman-docs.stsci.edu/data-handbook-home/roman-data-pipelines/exposure-level-pipeline#ExposureLevelPipeline-flatfield">Rdox documentation</a> for flat fielding.</p>
</section>
<section id="retrieving-reference-files">
<h3>Retrieving Reference Files<a class="headerlink" href="#retrieving-reference-files" title="Link to this heading">#</a></h3>
<p>As you run the exposure pipeline, the most up-to-date reference files will be automatically selected for each step. However, if you would like to use a specific reference file, these can be retrieved through the <code class="docutils literal notranslate"><span class="pre">crds</span></code> Python API and the ELP run with those files (more on that later). Let’s begin with how to access reference files from CRDS.</p>
<p>First, let’s start by looking at the <code class="docutils literal notranslate"><span class="pre">crds.getrecommendations()</span></code> function. This function returns a dictionary of file names that match the criteria that you supply. Selection criteria are specified in a dictionary of key-value pairs. Each Roman WFI metadata keyword in the dictionary is all-caps and always begins with “ROMAN.META.”. The remaining parts of the string correspond to the metadata keyword locations in the science data file schema. Different reference file types require different combinations of science metadata to match to the reference files. In general, all reference file types will require the instrument name (“INSTRUMENT.NAME”) and start time (“EXPOSURE.START_TIME”). Most file types require the detector name (“INSTRUMENT.DETECTOR”), and some file types require the exposure type (“EXPOSURE.TYPE”) or optical element (“INSTRUMENT.OPTICAL_ELEMENT”).</p>
<p>For the mask, dark, and flat files in particular, the required keywords are:</p>
<ul class="simple">
<li><p>mask</p>
<ul>
<li><p>ROMAN.META.INSTRUMENT.NAME</p></li>
<li><p>ROMAN.META.INSTRUMENT.DETECTOR</p></li>
<li><p>ROMAN.META.EXPOSURE.START_TIME</p></li>
</ul>
</li>
<li><p>dark</p>
<ul>
<li><p>ROMAN.META.INSTRUMENT.NAME</p></li>
<li><p>ROMAN.META.INSTRUMENT.DETECTOR</p></li>
<li><p>ROMAN.META.EXPOSURE.TYPE</p></li>
<li><p>ROMAN.META.EXPOSURE.START_TIME</p></li>
</ul>
</li>
<li><p>flat</p>
<ul>
<li><p>ROMAN.META.INSTRUMENT.NAME</p></li>
<li><p>ROMAN.META.INSTRUMENT.DETECTOR</p></li>
<li><p>ROMAN.META.INSTRUMENT.OPTICAL_ELEMENT</p></li>
<li><p>ROMAN.META.EXPOSURE.START_TIME</p></li>
</ul>
</li>
</ul>
<p>These keywords may be combined into a single dictionary to find multiple reference file types using <code class="docutils literal notranslate"><span class="pre">crds.getreferences()</span></code>. For example, if you would like to find the name of the dark and flat reference files used by the pipeline, you could run the following example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ROMAN.META.INSTRUMENT.NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.INSTRUMENT.DETECTOR&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI01&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.INSTRUMENT.OPTICAL_ELEMENT&#39;</span><span class="p">:</span> <span class="s1">&#39;F158&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.EXPOSURE.TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI_IMAGE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.EXPOSURE.START_TIME&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-01 00:00:00&#39;</span>
       <span class="p">}</span>

<span class="n">ref_files</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">getrecommendations</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">reftypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;dark&#39;</span><span class="p">,</span> <span class="s1">&#39;flat&#39;</span><span class="p">],</span> <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;roman&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ref_files</span></code> variable now contains a dictionary for each of the reference file types you requested (MASK, DARK, and FLAT). These are the reference files that correspond to a science observation taken at midnight UTC on January 1, 2024 in the WFI imaging mode with optical element F158 and detector WFI01. Let’s take a look at the names of the files CRDS returned:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;mask&#39;: &#39;roman_wfi_mask_0030.asdf&#39;,
 &#39;dark&#39;: &#39;roman_wfi_dark_0364.asdf&#39;,
 &#39;flat&#39;: &#39;roman_wfi_flat_0166.asdf&#39;}
</pre></div>
</div>
</div>
</div>
<p>We can also use <code class="docutils literal notranslate"><span class="pre">crds.getreferences()</span></code> to accomplish the same thing; however, <code class="docutils literal notranslate"><span class="pre">getreferences()</span></code> goes one step further beyond <code class="docutils literal notranslate"><span class="pre">getrecommendations()</span></code> and will download the reference files if they are not already in your local cache. Using the same example as above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ROMAN.META.INSTRUMENT.NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.INSTRUMENT.DETECTOR&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI01&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.INSTRUMENT.OPTICAL_ELEMENT&#39;</span><span class="p">:</span> <span class="s1">&#39;F158&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.EXPOSURE.TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI_IMAGE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.EXPOSURE.START_TIME&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-01 00:00:00&#39;</span>
       <span class="p">}</span>

<span class="n">ref_files</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">getreferences</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">reftypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;dark&#39;</span><span class="p">,</span> <span class="s1">&#39;flat&#39;</span><span class="p">],</span> <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;roman&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And once again we can examine the output of <code class="docutils literal notranslate"><span class="pre">ref_files</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;mask&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_mask_0030.asdf&#39;,
 &#39;dark&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf&#39;,
 &#39;flat&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_flat_0166.asdf&#39;}
</pre></div>
</div>
</div>
</div>
<p>This time, <code class="docutils literal notranslate"><span class="pre">ref_files</span></code> contains the path to the file in the local cache (controlled by the <code class="docutils literal notranslate"><span class="pre">CRDS_PATH</span></code> environment variable) since we did not simply ask for the file name but also checked if the file was in our cache, and if it was not then we downloaded it.</p>
</section>
<section id="crds-mapping-files">
<h3>CRDS Mapping Files<a class="headerlink" href="#crds-mapping-files" title="Link to this heading">#</a></h3>
<p>CRDS organizes the reference files using mapping files. The first mapping file, the IMAP, simply describes the instruments available for the observatory. In this case, we use the WFI IMAP and no action is needed by the user to select this. The PMAP file (commonly referred to as the CRDS context) is set by the the <code class="docutils literal notranslate"><span class="pre">CRDS_CONTEXT</span></code> environment variable. The context is also CRDS server-dependent, which is set by the environment variable <code class="docutils literal notranslate"><span class="pre">CRDS_SERVER_URL</span></code>. Let’s look at the values for both of those in this environment:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRDS server location: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CRDS context file: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRDS_CONTEXT&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS server location: https://roman-crds.stsci.edu
CRDS context file: roman_0041.pmap
</pre></div>
</div>
</div>
</div>
<p>The PMAP file contains the name of the IMAP and a list of RMAP file names as well as their contents. The RMAP files, one for each reference file type, list the names of the reference files and their selection criteria, which matches them to science observations. For more information on the mapping rules, see the <a class="reference external" href="https://roman-crds.stsci.edu/static/users_guide/rmap_syntax.html">readthedocs documentation</a>. Let’s take a look at our PMAP file first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pmap</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">rmap</span><span class="o">.</span><span class="n">load_mapping</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CRDS_CONTEXT&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">pmap</span></code> object contains all of the mapping information for every reference file in this context. This is a lot to look at, so let’s get the names of the mapping files contained within so we can look at one more closely:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maps</span> <span class="o">=</span> <span class="n">pmap</span><span class="o">.</span><span class="n">mapping_names</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s isolate the name of just the MASK rmap. We can pick the name above, but here we show how to do this programmatically:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;mask&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">mask_rmap</span> <span class="o">=</span> <span class="n">m</span> 
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">masks</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">rmap</span><span class="o">.</span><span class="n">load_mapping</span><span class="p">(</span><span class="n">mask_rmap</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have loaded up the RMAP, let’s take a look at it using the <code class="docutils literal notranslate"><span class="pre">todict()</span></code> method to turn it into a dictionary we can more easily visualize:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">masks</span><span class="o">.</span><span class="n">todict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;header&#39;: {&#39;classes&#39;: (&#39;Match&#39;, &#39;UseAfter&#39;),
  &#39;derived_from&#39;: &#39;roman_wfi_mask_0002.rmap&#39;,
  &#39;file_ext&#39;: &#39;.asdf&#39;,
  &#39;filekind&#39;: &#39;mask&#39;,
  &#39;filetype&#39;: &#39;mask&#39;,
  &#39;instrument&#39;: &#39;wfi&#39;,
  &#39;ld_tpn&#39;: &#39;wfi_mask.tpn&#39;,
  &#39;mapping&#39;: &#39;reference&#39;,
  &#39;name&#39;: &#39;roman_wfi_mask_0003.rmap&#39;,
  &#39;observatory&#39;: &#39;roman&#39;,
  &#39;parkey&#39;: ((&#39;ROMAN.META.INSTRUMENT.DETECTOR&#39;,),
   (&#39;ROMAN.META.EXPOSURE.START_TIME&#39;,)),
  &#39;sha1sum&#39;: &#39;47d1c37517e5e40cd13240f9ca432cf644b3994a&#39;,
  &#39;suffix&#39;: &#39;mask&#39;,
  &#39;text_descr&#39;: &#39;bad pixel mask&#39;,
  &#39;tpn&#39;: &#39;wfi_mask.tpn&#39;},
 &#39;text_descr&#39;: &#39;Bad Pixel Mask&#39;,
 &#39;parameters&#39;: (&#39;ROMAN.META.INSTRUMENT.DETECTOR&#39;, &#39;USEAFTER&#39;, &#39;REFERENCE&#39;),
 &#39;selections&#39;: [(&#39;WFI01&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0030.asdf&#39;),
  (&#39;WFI02&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0029.asdf&#39;),
  (&#39;WFI03&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0026.asdf&#39;),
  (&#39;WFI04&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0022.asdf&#39;),
  (&#39;WFI05&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0021.asdf&#39;),
  (&#39;WFI06&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0024.asdf&#39;),
  (&#39;WFI07&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0032.asdf&#39;),
  (&#39;WFI08&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0034.asdf&#39;),
  (&#39;WFI09&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0020.asdf&#39;),
  (&#39;WFI10&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0028.asdf&#39;),
  (&#39;WFI11&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0023.asdf&#39;),
  (&#39;WFI12&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0035.asdf&#39;),
  (&#39;WFI13&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0036.asdf&#39;),
  (&#39;WFI14&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0025.asdf&#39;),
  (&#39;WFI15&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0033.asdf&#39;),
  (&#39;WFI16&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0027.asdf&#39;),
  (&#39;WFI17&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0019.asdf&#39;),
  (&#39;WFI18&#39;, &#39;2023-01-01 00:00:00&#39;, &#39;roman_wfi_mask_0031.asdf&#39;)]}
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">parkey</span></code> key tells us the matching criteria unique to this reference file type from the dictionary we created when we used <code class="docutils literal notranslate"><span class="pre">crds.getrecommendations()</span></code> and <code class="docutils literal notranslate"><span class="pre">crds.getreferences()</span></code> (not shown are matching criteria always required by CRDS). Also notice that the <code class="docutils literal notranslate"><span class="pre">parameters</span></code> field tells us the column names for the <code class="docutils literal notranslate"><span class="pre">selections</span></code> part of the dictionary. In this case, we see they include “ROMAN.META.INSTRUMENT.DETECTOR”, “USEAFTER”, and “REFERENCE”. The REFERENCE column is simply the name of the reference file that matches those critiera. The USEAFTER date is the date after which a file should be used for a science observation. CRDS will match the file with the closest <strong>preceding</strong> USEAFTER date to the science observation date (given by “ROMAN.META.EXPOSURE.START_TIME”).</p>
</section>
<section id="download-a-file-by-name">
<h3>Download a File by Name<a class="headerlink" href="#download-a-file-by-name" title="Link to this heading">#</a></h3>
<p>If you know the specific reference file name and would like to download it directly from the CRDS on-premise server, you can call it via a command line option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crds</span> <span class="n">sync</span> <span class="o">--</span><span class="n">files</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="nb">dir</span><span class="o">=&lt;</span><span class="n">pathname</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;filename&gt;</span></code> is the name of the reference file (e.g. “roman_wfi_mask_0022.asdf”) and <code class="docutils literal notranslate"><span class="pre">&lt;pathname&gt;</span></code> is the location where the file will be saved. <strong>Note:</strong> in the future, Roman reference files will also be available via an AWS S3 bucket, and these instructions will be updated to describe how to access them there.</p>
<p>To run this in a Jupyter notebook, we write out the command as a string and pass it to the command line script code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;crds.sync --files </span><span class="si">{</span><span class="n">ref_files</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">sync</span><span class="o">.</span><span class="n">SyncScript</span><span class="p">(</span><span class="n">cmd</span><span class="p">)()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  Syncing explicitly listed files.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  0 errors
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  0 warnings
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRDS - INFO -  1 infos
</pre></div>
</div>
</div>
</div>
<p>In this case, nothing happened since we had already previously downloaded this file into our cache using <code class="docutils literal notranslate"><span class="pre">crds.getreferences()</span></code>. But if you know the file name of a reference file that you want to retrieve from CRDS without using the matching criteria, the cell above would download the file to your cache. Simply replace <code class="docutils literal notranslate"><span class="pre">{ref_files['mask']}</span></code> in the <code class="docutils literal notranslate"><span class="pre">cmd</span></code> string with the name of the ASDF file.</p>
</section>
<section id="examining-reference-files">
<h3>Examining Reference Files<a class="headerlink" href="#examining-reference-files" title="Link to this heading">#</a></h3>
<p>Reference files use <code class="docutils literal notranslate"><span class="pre">roman_datamodels</span></code> just like WFI science data products and can be accessed in the same way (see the tutorial <a class="reference internal" href="../working_with_asdf/working_with_asdf.html"><span class="std std-doc">Working with ASDF</span></a> for more information). Let’s take a closer look at the files we retrieved from our <code class="docutils literal notranslate"><span class="pre">crds.getreferences()</span></code> example starting with the mask file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_files</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
<span class="n">mask</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root (AsdfObject)
├─asdf_library (Software)
│ ├─author (str): The ASDF Developers
│ ├─homepage (str): http://github.com/asdf-format/asdf
│ ├─name (str): asdf
│ └─version (str): 3.3.0
├─history (AsdfDictNode)
│ └─extensions (AsdfListNode)
│   ├─0 (ExtensionMetadata) ...
│   ├─1 (ExtensionMetadata) ...
│   └─2 (ExtensionMetadata) ...
└─roman (MaskRef) # Mask Reference File Schema
  ├─meta (AsdfDictNode) # Common Reference File Metadata Properties
  │ ├─author (str): RFP # Author
  │ ├─description (str): Initial bad pixel masks for DQInit step in romancal.  Masks from NASA/GSFC # Description
  │ ├─instrument (AsdfDictNode) ...
  │ ├─origin (Origin): STSCI # Institution / Organization Name
  │ ├─pedigree (str): GROUND # Pedigree
  │ ├─reftype (str): MASK
  │ ├─telescope (Telescope): ROMAN # Telescope Name
  │ └─useafter (Time): 2023-01-01 00:00:00.000 # Use After Date
  └─dq (NDArrayType) # Mask Data Quality Array ...
Some nodes not shown.
</pre></div>
</div>
</div>
</div>
<p>We see that the mask file contains metadata and a single array called <code class="docutils literal notranslate"><span class="pre">dq</span></code>. If we display the <code class="docutils literal notranslate"><span class="pre">dq</span></code> array, then we can see all of the features that have been flagged. The <a class="reference internal" href="../working_with_asdf/working_with_asdf.html"><span class="std std-doc">Working with ASDF</span></a> tutorial gives more information about how to parse the meanings of the DQ flags. For now, let’s plot two versions of the file, one with each bitwise sum of DQ flags on a color map and another flattened version with “good” (DQ = 0; black pixels in the right-hand panel of the plot below) and “bad” (DQ &gt;= 1; white pixels in the right-hand panel of the plot below) flags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="c1"># Make a copy of the colormap so we can reset non-finite numbers to black</span>
<span class="n">my_cmap</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;nipy_spectral&#39;</span><span class="p">))</span>
<span class="n">my_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># Display the mask file with a log normalization using the updated color map</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">dq</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">5e5</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Science X (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Science Y (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Color-Coded DQ Flags&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="c1"># Display the mask file with boolean good and bad values on a grayscale map</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">dq</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;binary_r&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Science X (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Science Y (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Good vs Bad Flags&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6d19a0d49382d7a8fb24e74051634ef8372a3cc777a6d84dd9baa88662acd7e7.png" src="../../_images/6d19a0d49382d7a8fb24e74051634ef8372a3cc777a6d84dd9baa88662acd7e7.png" />
</div>
</div>
<p>Note that not all DQ flags &gt; 0 are necessarily bad. Many DQ flags are informational about detector effects or note something about the data processing. It is important for you to decide what effects are important for your science case.</p>
<p>Next, we’ll take a look at a dark. This isn’t as visually interesting for the WFI as the dark current is so low, so we will simply display the file information and discuss the contents.</p>
<p><strong>Note:</strong> Dark reference files from the Science Operations Center at STScI are still being developed. The dark files currently in CRDS are placeholders with all-zero values to enable simulations and pipeline processing. Updated darks are expected in early 2026.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dark</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_files</span><span class="p">[</span><span class="s1">&#39;dark&#39;</span><span class="p">])</span>
<span class="n">dark</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root (AsdfObject)
├─asdf_library (Software)
│ ├─author (str): The ASDF Developers
│ ├─homepage (str): http://github.com/asdf-format/asdf
│ ├─name (str): asdf
│ └─version (str): 4.1.0
├─history (AsdfDictNode)
│ └─extensions (AsdfListNode)
│   ├─0 (ExtensionMetadata) ...
│   ├─1 (ExtensionMetadata) ...
│   └─2 (ExtensionMetadata) ...
└─roman (DarkRef) # Dark Reference File Schema
  ├─meta (AsdfDictNode)
  │ ├─author (str): Rick Cosentino # Author
  │ ├─description (str): Dark reference file matching PRD MA Tables with all zeros with compressed data and  (truncated)
  │ ├─exposure (AsdfDictNode) ...
  │ ├─instrument (AsdfDictNode) ...
  │ ├─origin (Origin): STSCI # Institution / Organization Name
  │ └─4 not shown
  ├─data (NDArrayType) # Dark Current Array ...
  ├─dq (NDArrayType) # 2-D Data Quality Array ...
  ├─dark_slope (NDArrayType) # Dark Current Rate Array ...
  └─dark_slope_error (NDArrayType) # Dark Current Rate Uncertainty Array ...
Some nodes not shown.
</pre></div>
</div>
</div>
</div>
<p>In addition to metadata, we see there are several arrays. The <code class="docutils literal notranslate"><span class="pre">data</span></code> array contains a cube of dark values up-the-ramp. This is used in the current version of the ELP, however changes are being made towards a dark rate subtraction post-ramp-fitting. The <code class="docutils literal notranslate"><span class="pre">dark_slope</span></code> array contains the dark rate per pixel, and the <code class="docutils literal notranslate"><span class="pre">dark_slope_error</span></code> is the uncertainty in the dark rate. Finally, a <code class="docutils literal notranslate"><span class="pre">dq</span></code> array is present to flag effects in the dark current (such as hot pixels).</p>
<p>Finally, let’s examine a flat reference file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flat</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_files</span><span class="p">[</span><span class="s1">&#39;flat&#39;</span><span class="p">])</span>
<span class="n">flat</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>root (AsdfObject)
├─asdf_library (Software)
│ ├─author (str): The ASDF Developers
│ ├─homepage (str): http://github.com/asdf-format/asdf
│ ├─name (str): asdf
│ └─version (str): 3.5.0
├─history (AsdfDictNode)
│ └─extensions (AsdfListNode)
│   ├─0 (ExtensionMetadata) ...
│   └─1 (ExtensionMetadata) ...
└─roman (FlatRef) # Flat Reference File Schema
  ├─meta (AsdfDictNode)
  │ ├─author (str): Richard G Cosentino # Author
  │ ├─description (str): Flat reference file using TVAC2 data using CFA data from sRCS LED band 5, combining (truncated)
  │ ├─instrument (AsdfDictNode) ...
  │ ├─origin (Origin): STSCI # Institution / Organization Name
  │ ├─pedigree (str): GROUND # Pedigree
  │ ├─reftype (str): FLAT
  │ ├─telescope (Telescope): ROMAN # Telescope Name
  │ └─useafter (Time): 2023-08-01T00:00:00.000 # Use After Date
  ├─data (NDArrayType) # Flat Data Array ...
  ├─dq (NDArrayType) # 2-D Data Quality Array ...
  └─err (NDArrayType) # Flat Data Uncertainty Array ...
Some nodes not shown.
</pre></div>
</div>
</div>
</div>
<p>Once again, we see a <code class="docutils literal notranslate"><span class="pre">data</span></code> array, which in this case is the flatfield values, a <code class="docutils literal notranslate"><span class="pre">dq</span></code> array for flagging effects in the flatfield, and an <code class="docutils literal notranslate"><span class="pre">error</span></code> array. Let’s take a look at the flatfield for this detector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.5</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Science X (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Science Y (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flatfield&#39;</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.5</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Science X (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Science Y (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flatfield Error&#39;</span><span class="p">)</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">dq</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;binary_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Science X (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Science Y (pixels)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flatfield DQ&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/61622d64e427b0b2a77bb13751bbe80caee05aaa0c3944ff26b2df31ded01cc0.png" src="../../_images/61622d64e427b0b2a77bb13751bbe80caee05aaa0c3944ff26b2df31ded01cc0.png" />
</div>
</div>
</section>
</section>
<section id="how-to-override-romancal-with-local-reference-files">
<h2>How to Override RomanCal with Local Reference Files<a class="headerlink" href="#how-to-override-romancal-with-local-reference-files" title="Link to this heading">#</a></h2>
<p>If you have a local reference file that you would like to use in RomanCal processing, either one you retrieved from CRDS or one that you made yourself, then you can supply that when you run the ELP as an optional argument. The new reference file you indicate will override the CRDS best reference file selection from the server. Each reference file type has its own override parameter name (e.g., <code class="docutils literal notranslate"><span class="pre">override_mask</span></code>) and must be passed as arguments to the relevant step. Let’s look at an example now where we run the pipeline and override the mask and flat files. First, we need new reference files to use. For this example, let’s run <code class="docutils literal notranslate"><span class="pre">crds.getreferences()</span></code> and get new files for a different set of observation parameters, and then we can use those to override the best references. Our example is generally a bad idea, but for real applications you will likely already have a file on your disk storage that you want to use. Our example is to show how to override the reference file selection.</p>
<p>For our example, we will process a WFI01 L1 file with the ELP, but we will override the mask and flat files to be those from WFI04. Again, <strong>this is not recommended</strong> but simply designed to show how to override the reference file selection used by the pipeline if you have your own calibration reference files you want to use.</p>
<p><strong>Note:</strong> In <code class="docutils literal notranslate"><span class="pre">romancal</span></code> version 0.20.2 (August 2025), there is a bug when overriding reference files. Please make sure to disable the source catalog and tweakreg steps (as shown below) when overriding reference files to bypass this bug. This bug is already fixed in the next <code class="docutils literal notranslate"><span class="pre">romancal</span></code> version (0.21.0; November 2025), which is undergoing testing and validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ROMAN.META.INSTRUMENT.NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.INSTRUMENT.DETECTOR&#39;</span><span class="p">:</span> <span class="s1">&#39;WFI04&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.INSTRUMENT.OPTICAL_ELEMENT&#39;</span><span class="p">:</span> <span class="s1">&#39;F158&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROMAN.META.EXPOSURE.START_TIME&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-01 00:00:00&#39;</span>
       <span class="p">}</span>

<span class="n">ref_files</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">getreferences</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">reftypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;flat&#39;</span><span class="p">],</span> <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;roman&#39;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">ExposurePipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dm_l1</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;source_catalog&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;skip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="s1">&#39;tweakreg&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;skip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="s1">&#39;dq_init&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;override_mask&#39;</span><span class="p">:</span> <span class="n">ref_files</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]},</span>
                <span class="s1">&#39;flatfield&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;override_flat&#39;</span><span class="p">:</span> <span class="n">ref_files</span><span class="p">[</span><span class="s1">&#39;flat&#39;</span><span class="p">]}})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,249 - CRDS - ERROR -  Error determining best reference for &#39;pars-dqinitstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,250 - CRDS - ERROR -  Error determining best reference for &#39;pars-saturationstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,251 - CRDS - ERROR -  Error determining best reference for &#39;pars-refpixstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,252 - CRDS - ERROR -  Error determining best reference for &#39;pars-linearitystep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,253 - CRDS - ERROR -  Error determining best reference for &#39;pars-darkcurrentstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,254 - CRDS - ERROR -  Error determining best reference for &#39;pars-rampfitstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,255 - CRDS - ERROR -  Error determining best reference for &#39;pars-assignwcsstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,256 - CRDS - ERROR -  Error determining best reference for &#39;pars-flatfieldstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,257 - CRDS - ERROR -  Error determining best reference for &#39;pars-photomstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,258 - CRDS - ERROR -  Error determining best reference for &#39;pars-sourcecatalogstep&#39;  =   Unknown reference type &#39;pars-sourcecatalogstep&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,260 - CRDS - ERROR -  Error determining best reference for &#39;pars-tweakregstep&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,261 - CRDS - ERROR -  Error determining best reference for &#39;pars-exposurepipeline&#39;  =   No match found.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,266 - stpipe.ExposurePipeline - INFO - ExposurePipeline instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,268 - stpipe.ExposurePipeline.dq_init - INFO - DQInitStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,269 - stpipe.ExposurePipeline.saturation - INFO - SaturationStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,270 - stpipe.ExposurePipeline.refpix - INFO - RefPixStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,270 - stpipe.ExposurePipeline.linearity - INFO - LinearityStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,271 - stpipe.ExposurePipeline.dark_current - INFO - DarkCurrentStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,273 - stpipe.ExposurePipeline.rampfit - INFO - RampFitStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,274 - stpipe.ExposurePipeline.assign_wcs - INFO - AssignWcsStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,275 - stpipe.ExposurePipeline.flatfield - INFO - FlatFieldStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,275 - stpipe.ExposurePipeline.photom - INFO - PhotomStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,276 - stpipe.ExposurePipeline.source_catalog - INFO - SourceCatalogStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,278 - stpipe.ExposurePipeline.tweakreg - INFO - TweakRegStep instance created.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,486 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline running with args (&lt;roman_datamodels.datamodels._datamodels.ScienceRawModel object at 0x7f01a96a67b0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,498 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline parameters are:
  pre_hooks: []
  post_hooks: []
  output_file: None
  output_dir: None
  output_ext: .asdf
  output_use_model: False
  output_use_index: True
  save_results: False
  skip: False
  suffix: cal
  search_output_file: True
  input_dir: &#39;&#39;
  save_l1_wcs: False
  steps:
    dq_init:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    saturation:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    refpix:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      remove_offset: True
      remove_trends: True
      cosine_interpolate: True
      fft_interpolate: True
    linearity:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    dark_current:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      dark_output: None
    rampfit:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: rampfit
      search_output_file: True
      input_dir: &#39;&#39;
      algorithm: ols_cas22
      save_opt: False
      use_ramp_jump_detection: True
      threshold_intercept: None
      threshold_constant: None
    assign_wcs:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    flatfield:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      include_var_flat: False
    photom:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: False
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
    source_catalog:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: False
      output_use_index: True
      save_results: False
      skip: True
      suffix: cat
      search_output_file: True
      input_dir: &#39;&#39;
      bkg_boxsize: 1000
      kernel_fwhm: 2.0
      snr_threshold: 3.0
      npixels: 25
      deblend: False
      fit_psf: True
      forced_segmentation: &#39;&#39;
    tweakreg:
      pre_hooks: []
      post_hooks: []
      output_file: None
      output_dir: None
      output_ext: .asdf
      output_use_model: True
      output_use_index: True
      save_results: False
      skip: True
      suffix: None
      search_output_file: True
      input_dir: &#39;&#39;
      use_custom_catalogs: False
      catalog_format: ascii.ecsv
      catfile: &#39;&#39;
      catalog_path: &#39;&#39;
      enforce_user_order: False
      expand_refcat: False
      minobj: 15
      searchrad: 2.0
      use2dhist: True
      separation: 1.0
      tolerance: 0.7
      fitgeometry: rshift
      nclip: 3
      sigma: 3.0
      abs_refcat: GAIAREFCAT
      save_abs_catalog: False
      abs_minobj: 15
      abs_searchrad: 6.0
      abs_use2dhist: True
      abs_separation: 1.0
      abs_tolerance: 0.7
      abs_fitgeometry: rshift
      abs_nclip: 3
      abs_sigma: 3.0
      update_source_catalog_coordinates: False
      save_l1_wcs: True
      vo_timeout: 120.0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,500 - stpipe.ExposurePipeline - INFO - Prefetching reference files for dataset: &#39;r0003201001001001004_0001_wfi01_f106_uncal.asdf&#39; reftypes = [&#39;dark&#39;, &#39;distortion&#39;, &#39;gain&#39;, &#39;linearity&#39;, &#39;photom&#39;, &#39;readnoise&#39;, &#39;refpix&#39;, &#39;saturation&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,502 - stpipe.ExposurePipeline - INFO - Prefetch for DARK reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,503 - stpipe.ExposurePipeline - INFO - Prefetch for DISTORTION reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,503 - stpipe.ExposurePipeline - INFO - Override for FLAT reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_flat_0142.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,504 - stpipe.ExposurePipeline - INFO - Prefetch for GAIN reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_gain_0022.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,504 - stpipe.ExposurePipeline - INFO - Prefetch for LINEARITY reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_linearity_0039.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,505 - stpipe.ExposurePipeline - INFO - Override for MASK reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_mask_0022.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,506 - stpipe.ExposurePipeline - INFO - Prefetch for PHOTOM reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_photom_0040.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,506 - stpipe.ExposurePipeline - INFO - Prefetch for READNOISE reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_readnoise_0024.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,507 - stpipe.ExposurePipeline - INFO - Prefetch for REFPIX reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_refpix_0013.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,507 - stpipe.ExposurePipeline - INFO - Prefetch for SATURATION reference file is &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_saturation_0031.asdf&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,508 - romancal.pipeline.exposure_pipeline - INFO - Starting Roman exposure calibration pipeline ...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,709 - stpipe.ExposurePipeline.dq_init - INFO - Step dq_init running with args (&lt;roman_datamodels.datamodels._datamodels.ScienceRawModel object at 0x7f01a96a67b0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,787 - romancal.dq_init.dq_init_step - INFO - Flagging rows from: -999999 to -999999 as affected by guide window read
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:06,851 - stpipe.ExposurePipeline.dq_init - INFO - Step dq_init done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:07,050 - stpipe.ExposurePipeline.saturation - INFO - Step saturation running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a0aaaea0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:07,053 - romancal.saturation.saturation_step - INFO - Using SATURATION reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_saturation_0031.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:08,130 - stcal.saturation.saturation - INFO - Detected 73498 saturated pixels
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:08,174 - stcal.saturation.saturation - INFO - Detected 66525 A/D floor pixels
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:08,195 - stpipe.ExposurePipeline.saturation - INFO - Step saturation done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:08,478 - stpipe.ExposurePipeline.refpix - INFO - Step refpix running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a0aaaea0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/micromamba/envs/ci-env/lib/python3.13/site-packages/romancal/refpix/data.py:398: RuntimeWarning: invalid value encountered in divide
  kern = (cov / mask_conv).reshape(rows, columns)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:11,034 - stpipe.ExposurePipeline.refpix - INFO - Step refpix done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:11,234 - stpipe.ExposurePipeline.linearity - INFO - Step linearity running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a0aaaea0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:11,236 - romancal.linearity.linearity_step - INFO - Using LINEARITY reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_linearity_0039.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:12,685 - stpipe.ExposurePipeline.linearity - INFO - Step linearity done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:12,895 - stpipe.ExposurePipeline.rampfit - INFO - Step rampfit running with args (&lt;roman_datamodels.datamodels._datamodels.RampModel object at 0x7f01a0aaaea0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:12,899 - romancal.ramp_fitting.ramp_fit_step - INFO - Using READNOISE reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_readnoise_0024.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:12,914 - romancal.ramp_fitting.ramp_fit_step - INFO - Using GAIN reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_gain_0022.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:12,927 - romancal.ramp_fitting.ramp_fit_step - INFO - Jump detection as part of ramp fitting is enabled.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:19,893 - stpipe.ExposurePipeline.rampfit - INFO - Step rampfit done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:20,104 - stpipe.ExposurePipeline.dark_current - INFO - Step dark_current running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a0aaafd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:20,107 - romancal.dark_current.dark_current_step - INFO - Using DARK reference file: /home/runner/crds_cache/references/roman/wfi/roman_wfi_dark_0364.asdf
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:20,824 - stpipe.ExposurePipeline.dark_current - INFO - Step dark_current done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,029 - stpipe.ExposurePipeline.assign_wcs - INFO - Step assign_wcs running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a0aaafd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,029 - romancal.assign_wcs.assign_wcs_step - INFO - reftype, distortion
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,032 - romancal.assign_wcs.assign_wcs_step - INFO - Using reference files: {&#39;distortion&#39;: &#39;/home/runner/crds_cache/references/roman/wfi/roman_wfi_distortion_0014.asdf&#39;} for assign_wcs
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,082 - stcal.alignment.util - INFO - Update S_REGION to POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,083 - romancal.assign_wcs.utils - INFO - S_REGION VALUES: POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,083 - romancal.assign_wcs.utils - INFO - Update S_REGION to POLYGON ICRS  270.934685029 -0.225734417 270.934627258 -0.102770948 270.809037196 -0.102466475 270.809759493 -0.225325334
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,084 - stpipe.ExposurePipeline.assign_wcs - INFO - Step assign_wcs done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,293 - stpipe.ExposurePipeline.flatfield - INFO - Step flatfield running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a0aaafd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,569 - stpipe.ExposurePipeline.flatfield - INFO - Step flatfield done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,771 - stpipe.ExposurePipeline.photom - INFO - Step photom running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a0aaafd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,788 - romancal.photom.photom - INFO - photmjsr value: 0.741749
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,789 - romancal.photom.photom - INFO - uncertainty value: 0.0288573
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,791 - stpipe.ExposurePipeline.photom - INFO - Step photom done
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,996 - stpipe.ExposurePipeline.source_catalog - INFO - Step source_catalog running with args (&lt;roman_datamodels.datamodels._datamodels.ImageModel object at 0x7f01a0aaafd0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:21,996 - stpipe.ExposurePipeline.source_catalog - INFO - Step skipped.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:22,204 - stpipe.ExposurePipeline.tweakreg - INFO - Step tweakreg running with args (&lt;romancal.datamodels.library.ModelLibrary object at 0x7f0176abb9d0&gt;,).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:22,205 - stpipe.ExposurePipeline.tweakreg - INFO - Step skipped.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:22,206 - romancal.pipeline.exposure_pipeline - INFO - Roman exposure calibration pipeline ending...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-12-11 19:37:22,208 - stpipe.ExposurePipeline - INFO - Step ExposurePipeline done
</pre></div>
</div>
</div>
</div>
<p>Now let’s take a look at our <code class="docutils literal notranslate"><span class="pre">result</span></code> variable, which is our L2 datamodel in memory. Specifically, we can check the <code class="docutils literal notranslate"><span class="pre">meta.ref_file</span></code> section to see the names of the reference files used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ref_file</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>apcorr = N/A
area = N/A
dark = crds://roman_wfi_dark_0364.asdf
distortion = crds://roman_wfi_distortion_0014.asdf
epsf = N/A
flat = /home/runner/crds_cache/references/roman/wfi/roman_wfi_flat_0142.asdf
gain = crds://roman_wfi_gain_0022.asdf
inverse_linearity = N/A
linearity = crds://roman_wfi_linearity_0039.asdf
mask = /home/runner/crds_cache/references/roman/wfi/roman_wfi_mask_0022.asdf
photom = crds://roman_wfi_photom_0040.asdf
readnoise = crds://roman_wfi_readnoise_0024.asdf
refpix = crds://roman_wfi_refpix_0013.asdf
saturation = crds://roman_wfi_saturation_0031.asdf
crds = {&#39;version&#39;: &#39;13.0.6&#39;, &#39;context&#39;: &#39;roman_0041.pmap&#39;}
</pre></div>
</div>
</div>
</div>
<p>Indeed, we see that many of the files used came from CRDS (note the file names begin with “crds://”) whereas the flat and mask files contain a local path to the files we selected.</p>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Link to this heading">#</a></h2>
<p><strong>Author:</strong> T. Desjardins.</p>
<p><strong>Updated On:</strong> 2025-12-10</p>
<table width="100%" style="border:none; border-collapse:collapse;">
  <tr style="border:none;">
    <td style="border:none; width:180px; white-space:nowrap;">
       <a href="#top" style="text-decoration:none; color:#0066cc;">↑ Top of page</a> 
    </td>
    <td style="border:none; text-align:center;">
       <img src="../../roman_logo.png" width="50">
    </td>
    <td style="border:none; text-align:right;">
       <img src="../../stsci_logo2.png" width="90">
    </td>
  </tr>
</table></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/roman_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/exposure_pipeline"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../data_discovery_and_access/data_discovery_and_access.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Roman Research Nexus Data Discovery and Access in the Cloud</p>
      </div>
    </a>
    <a class="right-next"
       href="../footprint_visualization/footprint_visualization.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Visualization of Roman APT products</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-information-and-read-only-status">Kernel Information and Read-Only Status <a id="top"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#local-run-settings">Local Run Settings</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-calibration-reference-data-system-crds">The Calibration Reference Data System (CRDS)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorial-data">Tutorial Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-elp-on-l1-data">Running the ELP on L1 Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-example-full-pipeline">Basic Example: Full Pipeline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-example-running-individual-pipeline-steps">Advanced Example: Running Individual Pipeline Steps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-files">Reference Files</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bad-pixel-masks">Bad Pixel Masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#darks">Darks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flats">Flats</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-reference-files">Retrieving Reference Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#crds-mapping-files">CRDS Mapping Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#download-a-file-by-name">Download a File by Name</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examining-reference-files">Examining Reference Files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-override-romancal-with-local-reference-files">How to Override RomanCal with Local Reference Files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>